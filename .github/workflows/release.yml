name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.3.4)'
        required: true
        type: string

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish
      run: dotnet publish -c Release -r linux-x64 --self-contained -o ./publish

    - name: Create archive
      run: |
        cd publish
        tar -czvf ../BusLane-linux-x64.tar.gz .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: BusLane-linux-x64
        path: BusLane-linux-x64.tar.gz
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish
      run: dotnet publish -c Release -r win-x64 --self-contained -o ./publish

    - name: Create archive
      run: |
        Compress-Archive -Path ./publish/* -DestinationPath ./BusLane-win-x64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: BusLane-win-x64
        path: BusLane-win-x64.zip
        retention-days: 30

  build-macos:
    strategy:
      matrix:
        include:
          - runtime: osx-x64
            arch: x64
          - runtime: osx-arm64
            arch: arm64
    
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish
      run: dotnet publish -c Release -r ${{ matrix.runtime }} --self-contained -o ./publish

    - name: Create macOS App Bundle
      run: |
        APP_NAME="Bus Lane"
        APP_BUNDLE="${APP_NAME}.app"
        
        # Create app bundle structure
        mkdir -p "${APP_BUNDLE}/Contents/MacOS"
        mkdir -p "${APP_BUNDLE}/Contents/Resources"
        
        # Copy published files to MacOS folder
        cp -R ./publish/* "${APP_BUNDLE}/Contents/MacOS/"
        
        # Copy Info.plist
        cp Info.plist "${APP_BUNDLE}/Contents/"
        
        # Copy icon
        cp Assets/icon.icns "${APP_BUNDLE}/Contents/Resources/icon.icns"
        
        # Make the main executable executable
        chmod +x "${APP_BUNDLE}/Contents/MacOS/BusLane"
        
        # Create PkgInfo file
        echo -n "APPL????" > "${APP_BUNDLE}/Contents/PkgInfo"
        
        # Ad-hoc code sign the app bundle (allows running after removing quarantine)
        codesign --force --deep --sign - "${APP_BUNDLE}"

    - name: Create DMG installer
      run: |
        APP_NAME="Bus Lane"
        DMG_NAME="BusLane-osx-${{ matrix.arch }}"
        
        # Create a temporary directory for DMG contents
        mkdir -p dmg_contents
        cp -R "${APP_NAME}.app" dmg_contents/
        
        # Create a symbolic link to Applications folder
        ln -s /Applications dmg_contents/Applications
        
        # Create the DMG
        hdiutil create -volname "${APP_NAME}" -srcfolder dmg_contents -ov -format UDZO "${DMG_NAME}.dmg"

    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: BusLane-osx-${{ matrix.arch }}
        path: BusLane-osx-${{ matrix.arch }}.dmg
        retention-days: 30

  create-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: ls -R artifacts

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate release notes from commits
      id: release_notes
      run: |
        # Get the previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          # If no previous tag, get all commits
          COMMITS=$(git log --pretty=format:"- %s" --no-merges)
        else
          # Get commits between previous tag and current tag
          COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --no-merges)
        fi
        
        # Write to file to preserve newlines
        echo "$COMMITS" > release_notes.md
        
        echo "Generated release notes:"
        cat release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*.tar.gz
          artifacts/**/*.zip
          artifacts/**/*.dmg
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

