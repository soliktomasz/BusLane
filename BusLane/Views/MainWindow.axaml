<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:BusLane.ViewModels"
        xmlns:dashVm="using:BusLane.ViewModels.Dashboard"
        xmlns:models="using:BusLane.Models"
        xmlns:controls="using:BusLane.Views.Controls"
        xmlns:dialogs="using:BusLane.Views.Dialogs"
        xmlns:converters="using:BusLane.Converters"
        xmlns:ct="clr-namespace:CommunityToolkit.Mvvm.Input;assembly=CommunityToolkit.Mvvm"
        x:Class="BusLane.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        x:Name="MainWindowControl"
        Title="BusLane - Service Bus Manager"
        Icon="/Assets/icon.png"
        Width="1280" Height="800"
        MinWidth="1000" MinHeight="600"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <converters:EntitySelectionConverter x:Key="EntitySelectionConverter"/>
        <converters:EntitySelectionBackgroundConverter x:Key="EntitySelectionBackgroundConverter"/>
    </Window.Resources>

    <Grid ColumnDefinitions="Auto,Auto,*">
        <!-- Navigation Pane (Fluent 2 Sidebar) -->
        <controls:NavigationSidebar Grid.Column="0"
                                    IsVisible="{Binding IsNavigationPanelVisible}"/>

        <!-- Expand/Collapse Toggle Button -->
        <Border Grid.Column="1"
                Background="{DynamicResource SurfaceSubtle}"
                BorderBrush="{DynamicResource BorderDefault}"
                BorderThickness="0,0,1,0"
                VerticalAlignment="Stretch">
            <Button Classes="subtle"
                    Command="{Binding ToggleNavigationPanelCommand}"
                    ToolTip.Tip="Toggle navigation panel"
                    Padding="4,0"
                    Width="20"
                    VerticalAlignment="Stretch"
                    VerticalContentAlignment="Center">
                <Panel>
                    <LucideIcon Kind="ChevronLeft" Size="12"
                              IsVisible="{Binding IsNavigationPanelVisible}"/>
                    <LucideIcon Kind="ChevronRight" Size="12"
                              IsVisible="{Binding !IsNavigationPanelVisible}"/>
                </Panel>
            </Button>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Column="2" RowDefinitions="Auto,Auto,*">
            <!-- Tab Bar -->
            <controls:TabBarView Grid.Row="0"/>

            <!-- Update Notification Banner -->
            <controls:UpdateNotificationView Grid.Row="1"
                                             DataContext="{Binding UpdateNotification}"/>

            <!-- Content Area -->
            <Grid Grid.Row="2" Margin="24,20">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Welcome / Not Connected -->
                <controls:WelcomeView Grid.Row="1"
                                  VerticalAlignment="Center"
                                  HorizontalAlignment="Center"/>

            <!-- Content when namespace selected (Azure mode) -->
            <Grid Grid.Row="0" Grid.RowSpan="2"
                  IsVisible="{Binding IsActiveTabAzureMode}"
                  RowDefinitions="Auto,*">

                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="{Binding ActiveTab.Namespace.Name}" Classes="title"/>
                        <TextBlock Text="{Binding ActiveTab.Namespace.ResourceGroup}" Classes="caption" Margin="0,4,0,0"/>
                    </StackPanel>
                    <Button Classes="secondary small"
                            Command="{Binding RefreshCommand}"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <LucideIcon Kind="RefreshCw" Size="12"/>
                            <TextBlock Text="Refresh"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <!-- Main content grid -->
                <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*">
                    <!-- Service Bus Tree View -->
                    <controls:AzureEntityTreeView Grid.Column="0" Margin="0,0,12,0"/>

                    <!-- Messages Panel -->
                    <controls:MessagesPanelView Grid.Column="1" Margin="12,0,0,0"/>
                </Grid>
            </Grid>

            <!-- Content when connected via connection string -->
            <Grid Grid.Row="0" Grid.RowSpan="2"
                  IsVisible="{Binding IsActiveTabConnectionStringMode}"
                  RowDefinitions="Auto,*">

                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="{Binding ActiveTab.SavedConnection.Name}" Classes="title"/>
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,6,0,0">
                            <Border Classes="badge-info" Padding="8,4">
                                <TextBlock Text="{Binding ActiveTab.SavedConnection.TypeDisplayName}" FontSize="12" Foreground="{DynamicResource AccentBrand}"/>
                            </Border>
                            <TextBlock Text="{Binding ActiveTab.SavedConnection.EntityName}" Classes="caption" VerticalAlignment="Center"
                                       IsVisible="{Binding ActiveTab.SavedConnection.EntityName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <TextBlock Text="{Binding ActiveTab.SavedConnection.Endpoint}" Classes="caption" VerticalAlignment="Center"
                                       IsVisible="{Binding ActiveTab.SavedConnection.IsNamespaceLevel}"/>
                        </StackPanel>
                    </StackPanel>
                    <Button Classes="secondary small"
                            Command="{Binding RefreshConnectionCommand}"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <LucideIcon Kind="RefreshCw" Size="12"/>
                            <TextBlock Text="Refresh"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <!-- Main content for connection string mode -->
                <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*">
                    <!-- Entity Tree for connection string mode -->
                    <controls:EntityTreeView Grid.Column="0" Margin="0,0,12,0"/>

                    <!-- Messages Panel (reusing same structure as Azure mode) -->
                    <controls:MessagesPanelView Grid.Column="1" Margin="12,0,0,0"/>
                </Grid>
            </Grid>

            <!-- Live Stream Panel (overlay when active) -->
            <Border Grid.Row="0" Grid.RowSpan="2"
                    IsVisible="{Binding FeaturePanels.ShowLiveStream}"
                    Background="{DynamicResource AppBackground}">
                <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0" Margin="0,0,0,16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="Live Message Stream" Classes="title"/>
                            <Button Grid.Column="1" Classes="subtle"
                                    Command="{Binding CloseLiveStreamCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <LucideIcon Kind="X" Size="16"/>
                                    <TextBlock Text="Close"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </Border>
                    <controls:LiveStreamView Grid.Row="1" DataContext="{Binding FeaturePanels.LiveStreamViewModel}"/>
                </Grid>
            </Border>

            <!-- Charts Panel (overlay when active) -->
            <Border Grid.Row="0" Grid.RowSpan="2"
                    IsVisible="{Binding FeaturePanels.DashboardViewModel, Converter={x:Static ObjectConverters.IsNotNull}}"
                    Background="{DynamicResource AppBackground}">
                <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0" Margin="0,0,0,16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="Dashboard" Classes="title"/>
                            <Button Grid.Column="1" Classes="subtle"
                                    Command="{Binding CloseChartsCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <LucideIcon Kind="X" Size="16"/>
                                    <TextBlock Text="Close"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </Border>
                    <ContentControl Grid.Row="1" Content="{Binding FeaturePanels.DashboardViewModel}">
                        <ContentControl.ContentTemplate>
                            <DataTemplate DataType="dashVm:DashboardViewModel">
                                <controls:DashboardView />
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                </Grid>
            </Border>

            <!-- Tab Loading Overlay (shown when connecting to a namespace) -->
            <Border Grid.Row="0" Grid.RowSpan="2"
                    IsVisible="{Binding ActiveTab.IsLoading, FallbackValue=False}"
                    Background="{DynamicResource LoadingOverlay}"
                    IsHitTestVisible="True">
                <Border Background="{DynamicResource CardBackground}"
                        Padding="48,40"
                        CornerRadius="16"
                        BorderThickness="1"
                        BorderBrush="{DynamicResource BorderDefault}"
                        BoxShadow="0 12 48 0 #50000000"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        MinWidth="360">
                    <StackPanel Spacing="24" HorizontalAlignment="Center">
                        <!-- Animated loading ring -->
                        <Border Width="64" Height="64"
                                HorizontalAlignment="Center"
                                CornerRadius="32"
                                BorderThickness="4"
                                BorderBrush="{DynamicResource AccentBrand}"
                                Background="Transparent">
                            <Border.Styles>
                                <Style Selector="Border">
                                    <Style.Animations>
                                        <Animation Duration="0:0:1.2" IterationCount="INFINITE">
                                            <KeyFrame Cue="0%">
                                                <Setter Property="Opacity" Value="0.3"/>
                                            </KeyFrame>
                                            <KeyFrame Cue="50%">
                                                <Setter Property="Opacity" Value="1"/>
                                            </KeyFrame>
                                            <KeyFrame Cue="100%">
                                                <Setter Property="Opacity" Value="0.3"/>
                                            </KeyFrame>
                                        </Animation>
                                    </Style.Animations>
                                </Style>
                            </Border.Styles>
                        </Border>
                        
                        <StackPanel Spacing="12" HorizontalAlignment="Center">
                            <TextBlock Text="Connecting..."
                                       Classes="title-small"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding ActiveTab.StatusMessage}"
                                       FontSize="16"
                                       Foreground="{DynamicResource SubtleForeground}"
                                       HorizontalAlignment="Center"
                                       TextAlignment="Center"
                                       TextWrapping="Wrap"
                                       MaxWidth="300"/>
                        </StackPanel>
                        
                        <ProgressBar IsIndeterminate="True" 
                                     Width="240" 
                                     Height="4"
                                     Foreground="{DynamicResource AccentBrand}"
                                     Background="{DynamicResource BorderDefault}"/>
                    </StackPanel>
                </Border>
            </Border>

            <!-- Status Bar -->
            <Border Grid.Row="2" Margin="0,12,0,0">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <ProgressBar Grid.Column="0"
                                 IsIndeterminate="True"
                                 IsVisible="{Binding IsLoading}"
                                 Width="100" Height="3"
                                 VerticalAlignment="Center"/>
                    <Button Grid.Column="1"
                            Classes="subtle"
                            Command="{Binding ToggleStatusPopupCommand}"
                            HorizontalAlignment="Left"
                            Margin="12,0,0,0"
                            Padding="8,4"
                            Cursor="Hand"
                            ToolTip.Tip="Click to see full message">
                        <TextBlock Text="{Binding StatusMessage}"
                                   Classes="caption"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="400"/>
                    </Button>
                    <!-- Log Viewer Toggle Button -->
                    <ToggleButton Grid.Column="2"
                                  Classes="subtle icon-button"
                                  IsChecked="{Binding LogViewer.IsOpen}"
                                  Padding="6"
                                  Margin="8,0,0,0"
                                  ToolTip.Tip="Toggle activity log">
                        <LucideIcon Kind="ScrollText" Size="14"/>
                    </ToggleButton>
                </Grid>
            </Border>
            </Grid>
        </Grid>

        <!-- Modal Dialogs -->
        <dialogs:StatusPopupDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:MessageDetailDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:SendMessageDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:SaveMessageDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:LoadMessageDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:ConnectionLibraryDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:SettingsDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:ConfirmDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:KeyboardShortcutsDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:DeviceCodeDialog Grid.Column="0" Grid.ColumnSpan="3"/>

        <!-- Namespace Selection Slide-in Panel (Azure mode) -->
        <controls:NamespaceSelectionPanel Grid.Column="0" Grid.ColumnSpan="3"
                                          DataContext="{Binding NamespaceSelection}"/>

        <!-- Alerts Dialog (modal overlay) -->
        <Border Grid.Column="0" Grid.ColumnSpan="3"
                IsVisible="{Binding FeaturePanels.ShowAlerts}"
                Background="{DynamicResource ModalOverlay}">
            <Border Background="{DynamicResource CardBackground}"
                    CornerRadius="12"
                    MaxWidth="900" MaxHeight="700"
                    VerticalAlignment="Center" HorizontalAlignment="Center"
                    BoxShadow="0 8 24 0 #32000000">
                <dialogs:AlertsDialog DataContext="{Binding FeaturePanels.AlertsViewModel}"/>
            </Border>
        </Border>

        <!-- Log Viewer Slide-out Panel -->
        <controls:LogViewerPanel Grid.Column="0" Grid.ColumnSpan="3"
                                 DataContext="{Binding LogViewer}"/>
    </Grid>
</Window>

