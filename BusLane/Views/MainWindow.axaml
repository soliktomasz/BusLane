<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:BusLane.ViewModels"
        xmlns:models="using:BusLane.Models"
        xmlns:controls="using:BusLane.Views.Controls"
        xmlns:dialogs="using:BusLane.Views.Dialogs"
        xmlns:converters="using:BusLane.Converters"
        x:Class="BusLane.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Bus Lane - Service Bus Manager"
        Icon="/Assets/icon.png"
        Width="1280" Height="800"
        MinWidth="1000" MinHeight="600"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <converters:EntitySelectionConverter x:Key="EntitySelectionConverter"/>
        <converters:EntitySelectionBackgroundConverter x:Key="EntitySelectionBackgroundConverter"/>
    </Window.Resources>

    <Grid ColumnDefinitions="Auto,Auto,*">
        <!-- Navigation Pane (Fluent 2 Sidebar) -->
        <controls:NavigationSidebar Grid.Column="0"
                                    IsVisible="{Binding IsNavigationPanelVisible}"/>

        <!-- Expand/Collapse Toggle Button -->
        <Border Grid.Column="1"
                Background="{DynamicResource SurfaceSubtle}"
                BorderBrush="{DynamicResource BorderDefault}"
                BorderThickness="0,0,1,0"
                VerticalAlignment="Stretch">
            <Button Classes="subtle"
                    Command="{Binding ToggleNavigationPanelCommand}"
                    ToolTip.Tip="Toggle navigation panel"
                    Padding="4,0"
                    Width="20"
                    VerticalAlignment="Stretch"
                    VerticalContentAlignment="Center">
                <Panel>
                    <PathIcon Data="{StaticResource IconChevronLeft}"
                              Width="12" Height="12"
                              IsVisible="{Binding IsNavigationPanelVisible}"/>
                    <PathIcon Data="{StaticResource IconChevronRight}"
                              Width="12" Height="12"
                              IsVisible="{Binding !IsNavigationPanelVisible}"/>
                </Panel>
            </Button>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Column="2" RowDefinitions="Auto,*">
            <!-- Tab Bar -->
            <controls:TabBarView Grid.Row="0"/>

            <!-- Content Area -->
            <Grid Grid.Row="1" Margin="24,20">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Welcome / Not Connected -->
                <controls:WelcomeView Grid.Row="1"
                                  VerticalAlignment="Center"
                                  HorizontalAlignment="Center"/>

            <!-- Content when namespace selected (Azure mode) -->
            <Grid Grid.Row="0" Grid.RowSpan="2"
                  IsVisible="{Binding CurrentNavigation.SelectedNamespace, Converter={x:Static ObjectConverters.IsNotNull}}"
                  RowDefinitions="Auto,*">

                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="{Binding CurrentNavigation.SelectedNamespace.Name}" Classes="title"/>
                        <TextBlock Text="{Binding CurrentNavigation.SelectedNamespace.ResourceGroup}" Classes="caption" Margin="0,4,0,0"/>
                    </StackPanel>
                    <Button Classes="secondary small" Content="Refresh"
                            Command="{Binding RefreshCommand}"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"/>
                </Grid>

                <!-- Main content grid -->
                <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*">
                    <!-- Service Bus Tree View -->
                    <controls:AzureEntityTreeView Grid.Column="0" Margin="0,0,12,0"/>

                    <!-- Messages Panel -->
                    <controls:MessagesPanelView Grid.Column="1" Margin="12,0,0,0"/>
                </Grid>
            </Grid>

            <!-- Content when connected via connection string -->
            <Grid Grid.Row="0" Grid.RowSpan="2"
                  IsVisible="{Binding Connection.ActiveConnection, Converter={x:Static ObjectConverters.IsNotNull}}"
                  RowDefinitions="Auto,*">

                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="{Binding Connection.ActiveConnection.Name}" Classes="title"/>
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,6,0,0">
                            <Border Classes="badge-info" Padding="8,4">
                                <TextBlock Text="{Binding Connection.ActiveConnection.TypeDisplayName}" FontSize="12" Foreground="{DynamicResource AccentBrand}"/>
                            </Border>
                            <TextBlock Text="{Binding Connection.ActiveConnection.EntityName}" Classes="caption" VerticalAlignment="Center"
                                       IsVisible="{Binding Connection.ActiveConnection.EntityName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <TextBlock Text="{Binding Connection.ActiveConnection.Endpoint}" Classes="caption" VerticalAlignment="Center"
                                       IsVisible="{Binding Connection.ActiveConnection.IsNamespaceLevel}"/>
                        </StackPanel>
                    </StackPanel>
                    <Button Classes="secondary small" Content="Refresh"
                            Command="{Binding RefreshConnectionCommand}"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"/>
                </Grid>

                <!-- Main content for connection string mode -->
                <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*">
                    <!-- Entity Tree for connection string mode -->
                    <controls:EntityTreeView Grid.Column="0" Margin="0,0,12,0"/>

                    <!-- Messages Panel (reusing same structure as Azure mode) -->
                    <controls:MessagesPanelView Grid.Column="1" Margin="12,0,0,0"/>
                </Grid>
            </Grid>

            <!-- Live Stream Panel (overlay when active) -->
            <Border Grid.Row="0" Grid.RowSpan="2"
                    IsVisible="{Binding FeaturePanels.ShowLiveStream}"
                    Background="{DynamicResource AppBackground}">
                <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0" Margin="0,0,0,16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="Live Message Stream" Classes="title"/>
                            <Button Grid.Column="1" Classes="subtle" Content="✕ Close"
                                    Command="{Binding CloseLiveStreamCommand}"/>
                        </Grid>
                    </Border>
                    <controls:LiveStreamView Grid.Row="1" DataContext="{Binding FeaturePanels.LiveStreamViewModel}"/>
                </Grid>
            </Border>

            <!-- Charts Panel (overlay when active) -->
            <Border Grid.Row="0" Grid.RowSpan="2"
                    IsVisible="{Binding FeaturePanels.ChartsViewModel, Converter={x:Static ObjectConverters.IsNotNull}}"
                    Background="{DynamicResource AppBackground}">
                <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0" Margin="0,0,0,16">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="Metrics &amp; Charts" Classes="title"/>
                            <Button Grid.Column="1" Classes="subtle" Content="✕ Close"
                                    Command="{Binding CloseChartsCommand}"/>
                        </Grid>
                    </Border>
                    <ContentControl Grid.Row="1" Content="{Binding FeaturePanels.ChartsViewModel}">
                        <ContentControl.ContentTemplate>
                            <DataTemplate DataType="vm:ChartsViewModel">
                                <controls:ChartsView />
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                </Grid>
            </Border>

            <!-- Status Bar -->
            <Border Grid.Row="2" Margin="0,12,0,0">
                <Grid ColumnDefinitions="Auto,*">
                    <ProgressBar Grid.Column="0"
                                 IsIndeterminate="True"
                                 IsVisible="{Binding IsLoading}"
                                 Width="100" Height="3"/>
                    <Button Grid.Column="1"
                            Classes="subtle"
                            Command="{Binding ToggleStatusPopupCommand}"
                            HorizontalAlignment="Left"
                            Margin="12,0"
                            Padding="8,4"
                            Cursor="Hand"
                            ToolTip.Tip="Click to see full message">
                        <TextBlock Text="{Binding StatusMessage}"
                                   Classes="caption"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="400"/>
                    </Button>
                </Grid>
            </Border>
            </Grid>
        </Grid>

        <!-- Modal Dialogs -->
        <dialogs:StatusPopupDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:MessageDetailDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:SendMessageDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:SaveMessageDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:LoadMessageDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:ConnectionLibraryDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:SettingsDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:ConfirmDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:KeyboardShortcutsDialog Grid.Column="0" Grid.ColumnSpan="3"/>
        <dialogs:DeviceCodeDialog Grid.Column="0" Grid.ColumnSpan="3"/>

        <!-- Namespace Selection Slide-in Panel (Azure mode) -->
        <Grid Grid.Column="0" Grid.ColumnSpan="3"
              IsVisible="{Binding Connection.IsNamespacePanelOpen}">
            <!-- Overlay background (click to close) -->
            <Button Background="{DynamicResource ModalOverlay}"
                    Command="{Binding CloseNamespacePanelCommand}"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    BorderThickness="0"
                    CornerRadius="0"
                    Padding="0"
                    Cursor="Arrow">
                <Button.Template>
                    <ControlTemplate>
                        <Border Background="{TemplateBinding Background}"/>
                    </ControlTemplate>
                </Button.Template>
            </Button>

            <!-- Slide-in Panel from Left -->
            <Border Background="{DynamicResource CardBackground}"
                    Width="420"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    BorderBrush="{DynamicResource BorderDefault}"
                    BorderThickness="0,0,1,0"
                    BoxShadow="8 0 32 0 #30000000">

                <DockPanel>
                    <!-- Panel Header -->
                    <Border DockPanel.Dock="Top"
                            Background="{DynamicResource SurfaceSubtle}"
                            Padding="20,16"
                            BorderBrush="{DynamicResource BorderDefault}"
                            BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Text="Select Namespace" Classes="title" FontSize="20"/>
                                <TextBlock Text="Choose an Azure subscription and namespace to browse"
                                           Classes="caption" FontSize="12"/>
                            </StackPanel>
                            <Button Grid.Column="1" Classes="subtle"
                                    Command="{Binding CloseNamespacePanelCommand}"
                                    Padding="8"
                                    VerticalAlignment="Top">
                                <PathIcon Data="{StaticResource IconClose}" Width="16" Height="16"/>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Panel Content -->
                    <ScrollViewer DockPanel.Dock="Top" VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="20" Spacing="20">

                            <!-- Subscription Picker Card -->
                            <Border Background="{DynamicResource SurfaceSubtle}"
                                    CornerRadius="8"
                                    Padding="16">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <Border Width="36" Height="36" CornerRadius="8" Background="{DynamicResource SurfaceBrand}">
                                            <PathIcon Data="{StaticResource IconCloud}" Width="18" Height="18"
                                                      Foreground="{DynamicResource AccentBrand}"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel VerticalAlignment="Center" Spacing="2">
                                            <TextBlock Text="Azure Subscription" FontWeight="SemiBold" FontSize="14"/>
                                            <TextBlock Text="Select a subscription" Classes="caption" FontSize="12"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <ComboBox ItemsSource="{Binding CurrentNavigation.Subscriptions}"
                                              SelectedItem="{Binding CurrentNavigation.SelectedAzureSubscription}"
                                              HorizontalAlignment="Stretch"
                                              Padding="14,12"
                                              MinHeight="44">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate x:DataType="models:AzureSubscription">
                                                <TextBlock Text="{Binding Name}" TextTrimming="CharacterEllipsis" FontSize="14"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                            </Border>

                            <!-- Namespaces Section -->
                            <StackPanel Spacing="12">
                                <!-- Header with count -->
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                        <Border Width="32" Height="32" CornerRadius="8" Background="{DynamicResource AccentBrand}">
                                            <PathIcon Data="{StaticResource IconNamespace}" Width="16" Height="16"
                                                      Foreground="{DynamicResource TextOnBrand}"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <TextBlock Text="Namespaces" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <Border Grid.Column="2" Classes="badge-info" VerticalAlignment="Center" Padding="10,5">
                                        <TextBlock Text="{Binding CurrentNavigation.Namespaces.Count}" FontSize="12" FontWeight="SemiBold"/>
                                    </Border>
                                </Grid>

                                <!-- Search Box -->
                                <TextBox Text="{Binding CurrentNavigation.NamespaceFilter, Mode=TwoWay}"
                                         Watermark="Search by name, location, or resource group..."
                                         Padding="14,12"
                                         FontSize="13">
                                    <TextBox.InnerLeftContent>
                                        <PathIcon Data="{StaticResource IconSearch}" Width="14" Height="14"
                                                  Foreground="{DynamicResource SubtleForeground}"
                                                  Margin="4,0,0,0"/>
                                    </TextBox.InnerLeftContent>
                                </TextBox>

                                <!-- Namespace List -->
                                <Border Background="{DynamicResource SurfaceSubtle}"
                                        CornerRadius="8"
                                        Padding="8"
                                        MinHeight="200"
                                        MaxHeight="400">
                                    <ListBox ItemsSource="{Binding CurrentNavigation.FilteredNamespaces}"
                                             Classes="entity-list"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <VirtualizingStackPanel/>
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                        <ListBox.ItemTemplate>
                                            <DataTemplate x:DataType="models:ServiceBusNamespace">
                                                <Button Classes="subtle"
                                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectNamespaceCommand}"
                                                        CommandParameter="{Binding}"
                                                        HorizontalAlignment="Stretch"
                                                        HorizontalContentAlignment="Stretch"
                                                        Padding="0"
                                                        Margin="0,2">
                                                    <Grid ColumnDefinitions="Auto,*">
                                                        <!-- Selection indicator bar -->
                                                        <Border Grid.Column="0" Classes="selection-indicator"
                                                                VerticalAlignment="Stretch"
                                                                Margin="0,6,8,6">
                                                            <Border.IsVisible>
                                                                <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                    <Binding Path="."/>
                                                                    <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedNamespace"/>
                                                                </MultiBinding>
                                                            </Border.IsVisible>
                                                        </Border>

                                                        <!-- Namespace content -->
                                                        <Border Grid.Column="1" Padding="12,10" CornerRadius="8">
                                                            <Border.Background>
                                                                <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                    <Binding Path="."/>
                                                                    <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedNamespace"/>
                                                                </MultiBinding>
                                                            </Border.Background>
                                                            <Grid ColumnDefinitions="Auto,*">
                                                                <!-- Namespace Icon -->
                                                                <Border Grid.Column="0"
                                                                        Width="48" Height="48"
                                                                        CornerRadius="10"
                                                                        Background="{DynamicResource SurfaceBrand}"
                                                                        Margin="0,0,14,0">
                                                                    <TextBlock Text="SB" FontWeight="Bold" FontSize="15"
                                                                               Foreground="{DynamicResource AccentBrand}"
                                                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                </Border>

                                                                <!-- Namespace Details -->
                                                                <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="3">
                                                                    <TextBlock Text="{Binding Name}"
                                                                               FontWeight="SemiBold"
                                                                               FontSize="14"
                                                                               TextTrimming="CharacterEllipsis"/>
                                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                                        <PathIcon Data="{StaticResource IconLocation}" Width="11" Height="11"
                                                                                  Foreground="{DynamicResource SubtleForeground}"/>
                                                                        <TextBlock Text="{Binding Location}"
                                                                                   Classes="caption"
                                                                                   FontSize="12"
                                                                                   TextTrimming="CharacterEllipsis"/>
                                                                    </StackPanel>
                                                                    <TextBlock Text="{Binding ResourceGroup}"
                                                                               FontSize="11"
                                                                               Foreground="{DynamicResource MutedForeground}"
                                                                               TextTrimming="CharacterEllipsis"/>
                                                                </StackPanel>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                </Button>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </Border>

                                <!-- Empty state when no namespaces -->
                                <Border Background="{DynamicResource SurfaceSubtle}"
                                        CornerRadius="8"
                                        Padding="24"
                                        IsVisible="{Binding !CurrentNavigation.Namespaces.Count}">
                                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                                        <PathIcon Data="{StaticResource IconNamespace}" Width="32" Height="32"
                                                  Foreground="{DynamicResource SubtleForeground}"
                                                  HorizontalAlignment="Center"/>
                                        <TextBlock Text="No namespaces found"
                                                   Classes="caption"
                                                   HorizontalAlignment="Center"/>
                                        <TextBlock Text="Select a subscription above to load namespaces"
                                                   Classes="caption"
                                                   FontSize="11"
                                                   Foreground="{DynamicResource MutedForeground}"
                                                   HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Alerts Dialog (modal overlay) -->
        <Border Grid.Column="0" Grid.ColumnSpan="3"
                IsVisible="{Binding FeaturePanels.ShowAlerts}"
                Background="{DynamicResource ModalOverlay}">
            <Border Background="{DynamicResource CardBackground}"
                    CornerRadius="12"
                    MaxWidth="900" MaxHeight="700"
                    VerticalAlignment="Center" HorizontalAlignment="Center"
                    BoxShadow="0 8 32 0 #40000000">
                <dialogs:AlertsDialog DataContext="{Binding FeaturePanels.AlertsViewModel}"/>
            </Border>
        </Border>
    </Grid>
</Window>

