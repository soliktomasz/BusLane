<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BusLane.ViewModels"
             xmlns:models="using:BusLane.Models"
             xmlns:converters="using:BusLane.Converters"
             x:Class="BusLane.Views.Dialogs.ConnectionLibraryDialog"
             x:DataType="vm:MainWindowViewModel">

    <UserControl.Resources>
        <converters:EnvironmentTabConverter x:Key="EnvironmentTabConverter"/>
    </UserControl.Resources>

    <Border Classes="modal-overlay"
            IsVisible="{Binding Connection.ShowConnectionLibrary}">
        <Border Classes="modal"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                MinWidth="640"
                MaxWidth="720"
                MaxHeight="700"
                Padding="0">
            <Grid RowDefinitions="Auto,Auto,*">
                <!-- Header -->
                <Border Grid.Row="0"
                        BorderBrush="{DynamicResource BorderDefault}"
                        BorderThickness="0,0,0,1"
                        Padding="24,20">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Border Grid.Column="0"
                                Width="44" Height="44"
                                CornerRadius="12"
                                Background="{DynamicResource SurfaceBrand}"
                                Margin="0,0,16,0">
                            <PathIcon Data="{StaticResource IconConnection}"
                                      Width="24" Height="24"
                                      Foreground="{DynamicResource AccentBrand}"/>
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                            <TextBlock Text="My Connections" Classes="title" FontSize="20"/>
                            <TextBlock Text="Manage your saved Service Bus connections" Classes="caption"/>
                        </StackPanel>
                        <Button Grid.Column="2"
                                Classes="subtle"
                                Padding="8"
                                VerticalAlignment="Top"
                                Command="{Binding CloseConnectionLibraryCommand}">
                            <PathIcon Data="{StaticResource IconClose}" Width="16" Height="16"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- Tab Navigation -->
                <Border Grid.Row="1" Padding="24,16,24,0"
                        IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsAddingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}">
                    <Border Classes="tab-nav">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <RadioButton Classes="tab-item"
                                         Content="All"
                                         GroupName="EnvironmentTabs"
                                         IsChecked="{Binding Connection.ConnectionLibraryViewModel.SelectedEnvironmentTab,
                                             Converter={StaticResource EnvironmentTabConverter},
                                             ConverterParameter={x:Static models:ConnectionEnvironment.None}}"/>
                            <RadioButton Classes="tab-item"
                                         Content="Development"
                                         GroupName="EnvironmentTabs"
                                         IsChecked="{Binding Connection.ConnectionLibraryViewModel.SelectedEnvironmentTab,
                                             Converter={StaticResource EnvironmentTabConverter},
                                             ConverterParameter={x:Static models:ConnectionEnvironment.Development}}"/>
                            <RadioButton Classes="tab-item"
                                         Content="Test"
                                         GroupName="EnvironmentTabs"
                                         IsChecked="{Binding Connection.ConnectionLibraryViewModel.SelectedEnvironmentTab,
                                             Converter={StaticResource EnvironmentTabConverter},
                                             ConverterParameter={x:Static models:ConnectionEnvironment.Test}}"/>
                            <RadioButton Classes="tab-item"
                                         Content="Production"
                                         GroupName="EnvironmentTabs"
                                         IsChecked="{Binding Connection.ConnectionLibraryViewModel.SelectedEnvironmentTab,
                                             Converter={StaticResource EnvironmentTabConverter},
                                             ConverterParameter={x:Static models:ConnectionEnvironment.Production}}"/>
                        </StackPanel>
                    </Border>
                </Border>

                <!-- Content -->
                <ScrollViewer Grid.Row="2">
                    <Border Padding="24,16">
                        <StackPanel Spacing="16">

                            <!-- Quick Actions (when not adding) -->
                            <Border Classes="card" Padding="0" Background="{DynamicResource SurfaceSubtle}"
                                    IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsAddingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}">
                                <Border Padding="16">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <Button Classes="primary"
                                                Command="{Binding Connection.ConnectionLibraryViewModel.StartAddConnectionCommand}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <PathIcon Data="{StaticResource IconPlus}" Width="16" Height="16"/>
                                                <TextBlock Text="Add Connection"/>
                                            </StackPanel>
                                        </Button>
                                        <Button Classes="subtle"
                                                Command="{Binding Connection.ConnectionLibraryViewModel.ClearAllConnectionsCommand}"
                                                IsVisible="{Binding Connection.ConnectionLibraryViewModel.FilteredConnections.Count}">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <PathIcon Data="{StaticResource IconDelete}" Width="14" Height="14"/>
                                                <TextBlock Text="Clear All"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </Border>

                            <!-- Add/Edit Connection Form -->
                            <Border Classes="card" Padding="0" Background="{DynamicResource SurfaceSubtle}"
                                    IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsAddingConnection, FallbackValue=False}">
                                <StackPanel>
                                    <!-- Form Header -->
                                    <Border Padding="16,14"
                                            BorderBrush="{DynamicResource BorderDefault}"
                                            BorderThickness="0,0,0,1"
                                            Background="{DynamicResource CardBackground}"
                                            CornerRadius="8,8,0,0">
                                        <StackPanel Orientation="Horizontal" Spacing="12">
                                            <Border Width="28" Height="28"
                                                    CornerRadius="6"
                                                    Background="{DynamicResource SurfaceBrand}">
                                                <Panel>
                                                    <PathIcon Data="{StaticResource IconEdit}"
                                                              Width="16" Height="16"
                                                              Foreground="{DynamicResource AccentBrand}"
                                                              IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsEditingConnection}"/>
                                                    <PathIcon Data="{StaticResource IconPlus}"
                                                              Width="16" Height="16"
                                                              Foreground="{DynamicResource AccentBrand}"
                                                              IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsEditingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}"/>
                                                </Panel>
                                            </Border>
                                            <Panel>
                                                <TextBlock Text="Add New Connection"
                                                           FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"
                                                           IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsEditingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}"/>
                                                <TextBlock Text="Edit Connection"
                                                           FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"
                                                           IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsEditingConnection, FallbackValue=False}"/>
                                            </Panel>
                                        </StackPanel>
                                    </Border>

                                    <!-- Form Content -->
                                    <Border Padding="16">
                                        <StackPanel Spacing="16">
                                            <!-- Name and Environment Row -->
                                            <Grid ColumnDefinitions="*,160" ColumnSpacing="16">
                                                <StackPanel Grid.Column="0" Spacing="6">
                                                    <TextBlock Text="Connection name" FontWeight="Medium" FontSize="13"/>
                                                    <TextBox Text="{Binding Connection.ConnectionLibraryViewModel.NewConnectionName}"
                                                             Watermark="e.g., Production Service Bus"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1" Spacing="6">
                                                    <TextBlock Text="Environment" FontWeight="Medium" FontSize="13"/>
                                                    <ComboBox SelectedItem="{Binding Connection.ConnectionLibraryViewModel.NewConnectionEnvironment}"
                                                              ItemsSource="{Binding Connection.ConnectionLibraryViewModel.AvailableEnvironments}"
                                                              HorizontalAlignment="Stretch">
                                                        <ComboBox.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Text="{Binding}"/>
                                                            </DataTemplate>
                                                        </ComboBox.ItemTemplate>
                                                    </ComboBox>
                                                </StackPanel>
                                            </Grid>

                                            <Border Height="1" Background="{DynamicResource BorderDefault}"/>

                                            <!-- Connection String -->
                                            <StackPanel Spacing="6">
                                                <TextBlock Text="Connection string" FontWeight="Medium" FontSize="13"/>
                                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                    <TextBox Grid.Column="0"
                                                             Text="{Binding Connection.ConnectionLibraryViewModel.NewConnectionString}"
                                                             Watermark="Endpoint=sb://...;SharedAccessKeyName=...;SharedAccessKey=..."
                                                             PasswordChar="â—"
                                                             TextWrapping="Wrap"
                                                             AcceptsReturn="False"
                                                             MaxHeight="80"/>
                                                    <Button Grid.Column="1"
                                                            Classes="secondary"
                                                            ToolTip.Tip="Test connection"
                                                            Command="{Binding Connection.ConnectionLibraryViewModel.CheckConnectionCommand}"
                                                            IsEnabled="{Binding Connection.ConnectionLibraryViewModel.IsCheckingConnection, Converter={x:Static BoolConverters.Not}}"
                                                            VerticalAlignment="Top">
                                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                                            <PathIcon Data="{StaticResource IconTestConnection}" Width="16" Height="16"/>
                                                            <TextBlock Text="Test" IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsCheckingConnection, Converter={x:Static BoolConverters.Not}}"/>
                                                            <TextBlock Text="Testing..." IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsCheckingConnection}"/>
                                                        </StackPanel>
                                                    </Button>
                                                </Grid>
                                                <TextBlock Text="Your connection string is encrypted and stored securely"
                                                           Classes="caption" FontSize="11"/>
                                            </StackPanel>

                                            <!-- Success Result -->
                                            <Border Classes="infobar-success"
                                                    IsVisible="{Binding Connection.ConnectionLibraryViewModel.CheckConnectionSuccess, FallbackValue=False}">
                                                <StackPanel Orientation="Horizontal" Spacing="12">
                                                    <Border Width="28" Height="28"
                                                            CornerRadius="14"
                                                            Background="{DynamicResource TextSuccess}">
                                                        <PathIcon Data="{StaticResource IconCheck}"
                                                                  Width="14" Height="14"
                                                                  Foreground="{DynamicResource TextOnBrand}"/>
                                                    </Border>
                                                    <StackPanel VerticalAlignment="Center" Spacing="2">
                                                        <TextBlock Text="{Binding Connection.ConnectionLibraryViewModel.CheckConnectionResult}"
                                                                   FontWeight="Medium"/>
                                                        <TextBlock Text="{Binding Connection.ConnectionLibraryViewModel.DetectedInfo}"
                                                                   Classes="caption"
                                                                   IsVisible="{Binding Connection.ConnectionLibraryViewModel.DetectedInfo, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>

                                            <!-- Error Result -->
                                            <Border Classes="infobar-error">
                                                <Border.IsVisible>
                                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                        <Binding Path="Connection.ConnectionLibraryViewModel.CheckConnectionResult" Converter="{x:Static StringConverters.IsNotNullOrEmpty}"/>
                                                        <Binding Path="Connection.ConnectionLibraryViewModel.CheckConnectionSuccess" Converter="{x:Static BoolConverters.Not}"/>
                                                    </MultiBinding>
                                                </Border.IsVisible>
                                                <StackPanel Orientation="Horizontal" Spacing="12">
                                                    <Border Width="28" Height="28"
                                                            CornerRadius="14"
                                                            Background="{DynamicResource TextDanger}">
                                                        <PathIcon Data="{StaticResource IconWarning}"
                                                                  Width="14" Height="14"
                                                                  Foreground="{DynamicResource TextOnBrand}"/>
                                                    </Border>
                                                    <TextBlock Text="{Binding Connection.ConnectionLibraryViewModel.CheckConnectionResult}"
                                                               TextWrapping="Wrap"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>

                                            <!-- Validation Error -->
                                            <TextBlock Text="{Binding Connection.ConnectionLibraryViewModel.ValidationMessage}"
                                                       Foreground="{DynamicResource TextDanger}"
                                                       IsVisible="{Binding Connection.ConnectionLibraryViewModel.ValidationMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                       TextWrapping="Wrap"/>

                                            <Border Height="1" Background="{DynamicResource BorderDefault}"/>

                                            <!-- Form Actions -->
                                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                                                <Button Classes="secondary"
                                                        Command="{Binding Connection.ConnectionLibraryViewModel.CancelAddConnectionCommand}">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <PathIcon Data="{StaticResource IconClose}" Width="14" Height="14"/>
                                                        <TextBlock Text="Cancel"/>
                                                    </StackPanel>
                                                </Button>
                                                <Button Classes="primary"
                                                        Command="{Binding Connection.ConnectionLibraryViewModel.ValidateAndAddConnectionCommand}"
                                                        IsEnabled="{Binding Connection.ConnectionLibraryViewModel.IsValidating, Converter={x:Static BoolConverters.Not}}">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <PathIcon Data="{StaticResource IconSave}" Width="14" Height="14"/>
                                                        <Panel>
                                                            <TextBlock Text="Save Connection"
                                                                       IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsEditingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}"/>
                                                            <TextBlock Text="Update Connection"
                                                                       IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsEditingConnection, FallbackValue=False}"/>
                                                        </Panel>
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Border>

                            <!-- Saved Connections List -->
                            <Border Classes="card" Padding="0" Background="{DynamicResource SurfaceSubtle}"
                                    IsVisible="{Binding Connection.ConnectionLibraryViewModel.IsAddingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}">
                                <StackPanel>
                                    <!-- Section Header -->
                                    <Border Padding="16,14"
                                            BorderBrush="{DynamicResource BorderDefault}"
                                            BorderThickness="0,0,0,1"
                                            Background="{DynamicResource CardBackground}"
                                            CornerRadius="8,8,0,0">
                                        <StackPanel Orientation="Horizontal" Spacing="12">
                                            <Border Width="28" Height="28"
                                                    CornerRadius="6"
                                                    Background="{DynamicResource SurfaceBrand}">
                                                <PathIcon Data="{StaticResource IconConnection}"
                                                          Width="16" Height="16"
                                                          Foreground="{DynamicResource AccentBrand}"/>
                                            </Border>
                                            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                                                <TextBlock Text="Saved Connections" FontWeight="SemiBold" FontSize="14"/>
                                                <Border Classes="badge-info" CornerRadius="10" Padding="8,3"
                                                        IsVisible="{Binding Connection.ConnectionLibraryViewModel.FilteredConnections.Count}">
                                                    <TextBlock Text="{Binding Connection.ConnectionLibraryViewModel.FilteredConnections.Count}" FontSize="12"/>
                                                </Border>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>

                                    <!-- Empty State -->
                                    <Border Padding="16">
                                        <StackPanel IsVisible="{Binding !Connection.ConnectionLibraryViewModel.FilteredConnections.Count, FallbackValue=True}"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Center"
                                                    Spacing="12"
                                                    Margin="0,24">
                                            <Border Width="64" Height="64"
                                                    CornerRadius="32"
                                                    Background="{DynamicResource SurfaceSubtle}"
                                                    HorizontalAlignment="Center"
                                                    BorderThickness="2"
                                                    BorderBrush="{DynamicResource BorderDefault}">
                                                <PathIcon Data="{StaticResource IconConnection}"
                                                          Width="28" Height="28"
                                                          Foreground="{DynamicResource SubtleForeground}"/>
                                            </Border>
                                            <TextBlock Text="No connections saved"
                                                       FontSize="16"
                                                       FontWeight="SemiBold"
                                                       HorizontalAlignment="Center"/>
                                            <TextBlock Text="Add a connection to get started"
                                                       FontSize="13"
                                                       Foreground="{DynamicResource SubtleForeground}"
                                                       HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Connections List -->
                                    <ItemsControl ItemsSource="{Binding Connection.ConnectionLibraryViewModel.FilteredConnections}"
                                                  Margin="8,0,8,8">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="models:SavedConnection">
                                                <Border Padding="16"
                                                        Margin="0,0,0,8"
                                                        CornerRadius="8"
                                                        Background="{DynamicResource CardBackground}"
                                                        BorderThickness="1"
                                                        BorderBrush="{DynamicResource BorderDefault}">
                                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                                        <!-- Connection Icon -->
                                                        <Border Grid.Column="0"
                                                                Width="40" Height="40"
                                                                CornerRadius="10"
                                                                Background="{DynamicResource SurfaceBrand}"
                                                                Margin="0,0,16,0"
                                                                VerticalAlignment="Center">
                                                            <PathIcon Data="{StaticResource IconConnection}"
                                                                      Width="20" Height="20"
                                                                      Foreground="{DynamicResource AccentBrand}"/>
                                                        </Border>

                                                        <!-- Connection Info -->
                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="6">
                                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                                <TextBlock Text="{Binding Name}"
                                                                           FontWeight="SemiBold"
                                                                           FontSize="14"/>
                                                                <PathIcon Data="{StaticResource IconStarFilled}"
                                                                          Width="14" Height="14"
                                                                          Foreground="{DynamicResource TextWarning}"
                                                                          IsVisible="{Binding IsFavorite}"
                                                                          VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                                <Border Classes="badge-info" Padding="8,3">
                                                                    <TextBlock Text="{Binding TypeDisplayName}" FontSize="11"/>
                                                                </Border>
                                                                <Border Classes="badge-env" Padding="8,3" IsVisible="{Binding HasEnvironment}">
                                                                    <TextBlock Text="{Binding EnvironmentDisplayName}" FontSize="11" FontWeight="SemiBold"/>
                                                                </Border>
                                                                <TextBlock Text="{Binding EntityName}"
                                                                           Classes="caption"
                                                                           FontSize="12"
                                                                           VerticalAlignment="Center"
                                                                           IsVisible="{Binding EntityName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                                                <TextBlock Text="{Binding Endpoint}"
                                                                           Classes="caption"
                                                                           FontSize="12"
                                                                           VerticalAlignment="Center"
                                                                           IsVisible="{Binding IsNamespaceLevel}"/>
                                                            </StackPanel>
                                                            <TextBlock Text="{Binding CreatedAt, StringFormat='Added {0:MMM d, yyyy}'}"
                                                                       FontSize="12"
                                                                       Foreground="{DynamicResource MutedForeground}"/>
                                                        </StackPanel>

                                                        <!-- Actions -->
                                                        <StackPanel Grid.Column="2"
                                                                    Orientation="Horizontal"
                                                                    Spacing="4"
                                                                    VerticalAlignment="Center">
                                                            <Button Classes="subtle small"
                                                                    ToolTip.Tip="{Binding IsFavorite, Converter={x:Static BoolConverters.Not}, ConverterParameter='Add to favorites', FallbackValue='Add to favorites'}"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Connection.ConnectionLibraryViewModel.ToggleFavoriteCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    Padding="8">
                                                                <Panel>
                                                                    <PathIcon Data="{StaticResource IconStarOutline}" Width="16" Height="16" IsVisible="{Binding !IsFavorite}"/>
                                                                    <PathIcon Data="{StaticResource IconStarFilled}" Width="16" Height="16" Foreground="{DynamicResource TextWarning}" IsVisible="{Binding IsFavorite}"/>
                                                                </Panel>
                                                            </Button>
                                                            <Button Classes="subtle small"
                                                                    ToolTip.Tip="Edit"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Connection.ConnectionLibraryViewModel.StartEditConnectionCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    Padding="8">
                                                                <PathIcon Data="{StaticResource IconEdit}" Width="16" Height="16"/>
                                                            </Button>
                                                            <Button Classes="danger-subtle small"
                                                                    ToolTip.Tip="Delete"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Connection.ConnectionLibraryViewModel.DeleteConnectionCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    Padding="8">
                                                                <PathIcon Data="{StaticResource IconDelete}" Width="16" Height="16"/>
                                                            </Button>
                                                            <Button Classes="primary small"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Connection.ConnectionLibraryViewModel.SelectConnectionCommand}"
                                                                    CommandParameter="{Binding}">
                                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                                    <PathIcon Data="{StaticResource IconStream}" Width="14" Height="14"/>
                                                                    <TextBlock Text="Connect"/>
                                                                </StackPanel>
                                                            </Button>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>

                        </StackPanel>
                    </Border>
                </ScrollViewer>
            </Grid>
        </Border>
    </Border>
</UserControl>
