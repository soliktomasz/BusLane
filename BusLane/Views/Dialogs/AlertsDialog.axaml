<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BusLane.ViewModels"
             xmlns:models="using:BusLane.Models"
             x:Class="BusLane.Views.Dialogs.AlertsDialog"
             x:DataType="vm:AlertsViewModel">

    <Border Classes="modal-overlay">
        <Border Classes="modal"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                MinWidth="640"
                MaxWidth="720"
                MaxHeight="700"
                Padding="0">
            <Grid RowDefinitions="Auto,Auto,*,Auto">
                <!-- Header -->
                <Border Grid.Row="0"
                        BorderBrush="{DynamicResource BorderDefault}"
                        BorderThickness="0,0,0,1"
                        Padding="24,20">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Border Grid.Column="0"
                                Width="44" Height="44"
                                CornerRadius="12"
                                Background="{DynamicResource SurfaceDanger}"
                                Margin="0,0,16,0">
                            <LucideIcon Kind="Bell" Size="24"
                                      Foreground="{DynamicResource TextDanger}"/>
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="Alerts" Classes="title-small"/>
                                <Border Classes="badge-danger" CornerRadius="10" Padding="8,3"
                                        IsVisible="{Binding HasAlerts}" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding UnacknowledgedCount}" FontSize="12"/>
                                </Border>
                            </StackPanel>
                            <TextBlock Text="Monitor thresholds and configure alert rules" Classes="caption"/>
                        </StackPanel>
                        <Button Grid.Column="2"
                                Classes="subtle"
                                Padding="8"
                                VerticalAlignment="Top"
                                Command="{Binding CloseCommand}">
                            <LucideIcon Kind="X" Size="16"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- Tab Navigation -->
                <Border Grid.Row="1" Padding="24,16,24,0">
                    <Border Classes="tab-nav">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <RadioButton Classes="tab-item"
                                         Content="Active Alerts"
                                         IsChecked="{Binding IsActiveAlertsTabSelected}"
                                         GroupName="AlertTabs"/>
                            <RadioButton Classes="tab-item"
                                         Content="Alert Rules"
                                         IsChecked="{Binding IsRulesTabSelected}"
                                         GroupName="AlertTabs"/>
                        </StackPanel>
                    </Border>
                </Border>

                <!-- Content -->
                <ScrollViewer Grid.Row="2">
                    <Border Padding="24,16">
                        <Grid>
                            <!-- Active Alerts Tab Content -->
                            <StackPanel Spacing="16" IsVisible="{Binding IsActiveAlertsTabSelected}">

                                <!-- Quick Actions -->
                                <Border Classes="card" Padding="0" Background="{DynamicResource SurfaceSubtle}"
                                        IsVisible="{Binding HasAlerts}">
                                    <Border Padding="16">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <Button Classes="primary small"
                                                    Command="{Binding AcknowledgeAllAlertsCommand}">
                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                    <LucideIcon Kind="Check" Size="14"/>
                                                    <TextBlock Text="Acknowledge All"/>
                                                </StackPanel>
                                            </Button>
                                            <Button Classes="subtle small"
                                                    Command="{Binding ClearAcknowledgedAlertsCommand}">
                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                    <LucideIcon Kind="Trash2" Size="14"/>
                                                    <TextBlock Text="Clear Acknowledged"/>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>
                                    </Border>
                                </Border>

                                <!-- Alerts List -->
                                <Border Classes="card" Padding="0" Background="{DynamicResource SurfaceSubtle}">
                                    <StackPanel>
                                        <!-- Section Header -->
                                        <Border Padding="16,14"
                                                BorderBrush="{DynamicResource BorderDefault}"
                                                BorderThickness="0,0,0,1"
                                                Background="{DynamicResource CardBackground}"
                                                CornerRadius="8,8,0,0">
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <Border Width="28" Height="28"
                                                        CornerRadius="6"
                                                        Background="{DynamicResource SurfaceWarning}">
                                                    <LucideIcon Kind="TriangleAlert" Size="16"
                                                              Foreground="{DynamicResource TextWarning}"/>
                                                </Border>
                                                <TextBlock Text="Triggered Alerts" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Alerts Content -->
                                        <Border Padding="16">
                                            <!-- Empty State -->
                                            <StackPanel IsVisible="{Binding !HasAlerts}"
                                                        VerticalAlignment="Center"
                                                        HorizontalAlignment="Center"
                                                        Spacing="12"
                                                        Margin="0,24">
                                                <Border Width="64" Height="64"
                                                        CornerRadius="32"
                                                        Background="{DynamicResource SurfaceSuccess}"
                                                        HorizontalAlignment="Center">
                                                    <LucideIcon Kind="CircleCheck" Size="32"
                                                              Foreground="{DynamicResource TextSuccess}"/>
                                                </Border>
                                                <TextBlock Text="All clear"
                                                           FontSize="16"
                                                           FontWeight="SemiBold"
                                                           HorizontalAlignment="Center"/>
                                                <TextBlock Text="No active alerts at this time"
                                                           FontSize="13"
                                                           Foreground="{DynamicResource SubtleForeground}"
                                                           HorizontalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Alerts List -->
                                        <ItemsControl ItemsSource="{Binding ActiveAlerts}"
                                                      IsVisible="{Binding HasAlerts}"
                                                      Margin="8,0,8,8">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="models:AlertEvent">
                                                    <Border Padding="16"
                                                            Margin="0,0,0,8"
                                                            CornerRadius="8"
                                                            Background="{DynamicResource CardBackground}"
                                                            BorderThickness="1"
                                                            BorderBrush="{DynamicResource BorderDefault}"
                                                            Opacity="{Binding IsAcknowledged, Converter={StaticResource BoolToOpacityConverter}}">
                                                        <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">
                                                            <!-- Severity Icon -->
                                                            <Border Grid.Column="0" Grid.RowSpan="3"
                                                                    Width="40" Height="40"
                                                                    CornerRadius="10"
                                                                    Background="{Binding Rule.Severity, Converter={StaticResource SeverityToBackgroundConverter}}"
                                                                    Margin="0,0,16,0"
                                                                    VerticalAlignment="Top">
                                                                <LucideIcon Kind="Bell" Size="20"
                                                                          Foreground="{Binding Rule.Severity, Converter={StaticResource SeverityToColorConverter}}"/>
                                                            </Border>

                                                            <!-- Alert Title and Badge -->
                                                            <StackPanel Grid.Column="1" Grid.Row="0"
                                                                        Orientation="Horizontal"
                                                                        Spacing="10">
                                                                <TextBlock Text="{Binding Rule.Name}"
                                                                           FontWeight="SemiBold"
                                                                           FontSize="14"/>
                                                                <Border CornerRadius="4" Padding="8,3"
                                                                        Background="{Binding Rule.Severity, Converter={StaticResource SeverityToBackgroundConverter}}">
                                                                    <TextBlock Text="{Binding Rule.Severity}"
                                                                               FontSize="11"
                                                                               FontWeight="Medium"
                                                                               Foreground="{Binding Rule.Severity, Converter={StaticResource SeverityToColorConverter}}"/>
                                                                </Border>
                                                            </StackPanel>

                                                            <!-- Entity Info -->
                                                            <TextBlock Grid.Column="1" Grid.Row="1"
                                                                       FontSize="13"
                                                                       Foreground="{DynamicResource SubtleForeground}"
                                                                       Margin="0,4,0,0">
                                                                <Run Text="{Binding EntityType}"/>
                                                                <Run Text=": "/>
                                                                <Run Text="{Binding EntityName}" FontWeight="SemiBold"/>
                                                            </TextBlock>

                                                            <!-- Metrics and Time -->
                                                            <StackPanel Grid.Column="1" Grid.Row="2"
                                                                        Orientation="Horizontal"
                                                                        Spacing="16"
                                                                        Margin="0,6,0,0">
                                                                <TextBlock FontSize="12" Foreground="{DynamicResource MutedForeground}">
                                                                    <Run Text="Value: "/>
                                                                    <Run Text="{Binding CurrentValue, StringFormat='{}{0:N0}'}" FontWeight="Medium"/>
                                                                    <Run Text=" / "/>
                                                                    <Run Text="{Binding Rule.Threshold, StringFormat='{}{0:N0}'}"/>
                                                                </TextBlock>
                                                                <TextBlock Text="{Binding TriggeredAt, StringFormat='{}{0:g}'}"
                                                                           FontSize="12"
                                                                           Foreground="{DynamicResource MutedForeground}"/>
                                                            </StackPanel>

                                                            <!-- Acknowledge Button -->
                                                            <Button Grid.Column="2" Grid.RowSpan="3"
                                                                    Classes="primary small"
                                                                    Command="{Binding $parent[ItemsControl].((vm:AlertsViewModel)DataContext).AcknowledgeAlertCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    IsVisible="{Binding !IsAcknowledged}"
                                                                    VerticalAlignment="Center">
                                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                                    <LucideIcon Kind="Check" Size="14"/>
                                                                    <TextBlock Text="Acknowledge"/>
                                                                </StackPanel>
                                                            </Button>

                                                            <Border Grid.Column="2" Grid.RowSpan="3"
                                                                    Classes="badge-success"
                                                                    IsVisible="{Binding IsAcknowledged}"
                                                                    VerticalAlignment="Center">
                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                    <LucideIcon Kind="Check" Size="12"/>
                                                                    <TextBlock Text="Done"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <!-- Alert Rules Tab Content -->
                            <StackPanel Spacing="16" IsVisible="{Binding IsRulesTabSelected}">

                                <!-- Add/Edit Rule Form -->
                                <Border Classes="card" Padding="0" Background="{DynamicResource SurfaceSubtle}"
                                        IsVisible="{Binding IsAddingRule}">
                                    <StackPanel>
                                        <!-- Form Header -->
                                        <Border Padding="16,14"
                                                BorderBrush="{DynamicResource BorderDefault}"
                                                BorderThickness="0,0,0,1"
                                                Background="{DynamicResource CardBackground}"
                                                CornerRadius="8,8,0,0">
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <Border Width="28" Height="28"
                                                        CornerRadius="6"
                                                        Background="{DynamicResource SurfaceBrand}">
                                                    <Panel>
                                                        <LucideIcon Kind="Pencil" Size="16"
                                                                  Foreground="{DynamicResource AccentBrand}"
                                                                  IsVisible="{Binding IsEditingRule}"/>
                                                        <LucideIcon Kind="Plus" Size="16"
                                                                  Foreground="{DynamicResource AccentBrand}"
                                                                  IsVisible="{Binding !IsEditingRule}"/>
                                                    </Panel>
                                                </Border>
                                                <TextBlock Text="{Binding FormTitle}"
                                                           FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Form Content -->
                                        <Border Padding="16">
                                            <StackPanel Spacing="16">
                                                <!-- Rule Name -->
                                                <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                                                    <StackPanel Grid.Column="0" Spacing="6">
                                                        <TextBlock Text="Rule name" FontWeight="Medium" FontSize="13"/>
                                                        <TextBox Text="{Binding RuleName}"
                                                                 Watermark="e.g., High dead letters"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1" Spacing="6">
                                                        <TextBlock Text="Alert type" FontWeight="Medium" FontSize="13"/>
                                                        <ComboBox ItemsSource="{Binding AvailableAlertTypes}"
                                                                  SelectedItem="{Binding SelectedAlertType}"
                                                                  HorizontalAlignment="Stretch"/>
                                                    </StackPanel>
                                                </Grid>

                                                <Border Height="1" Background="{DynamicResource BorderDefault}"/>

                                                <!-- Severity and Threshold -->
                                                <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                                                    <StackPanel Grid.Column="0" Spacing="6">
                                                        <TextBlock Text="Severity" FontWeight="Medium" FontSize="13"/>
                                                        <ComboBox ItemsSource="{Binding AvailableSeverities}"
                                                                  SelectedItem="{Binding SelectedSeverity}"
                                                                  HorizontalAlignment="Stretch"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1" Spacing="6">
                                                        <TextBlock Text="Threshold" FontWeight="Medium" FontSize="13"/>
                                                        <NumericUpDown Value="{Binding Threshold}"
                                                                       Minimum="1"
                                                                       FormatString="N0"/>
                                                    </StackPanel>
                                                </Grid>

                                                <Border Height="1" Background="{DynamicResource BorderDefault}"/>

                                                <!-- Entity Pattern -->
                                                <StackPanel Spacing="6">
                                                    <TextBlock Text="Entity pattern (optional)" FontWeight="Medium" FontSize="13"/>
                                                    <TextBox Text="{Binding EntityPattern}"
                                                             Watermark="e.g., orders-.* (regex supported, leave empty for all)"/>
                                                    <TextBlock Text="Use regex patterns to match specific queues or topics"
                                                               Classes="caption"/>
                                                </StackPanel>

                                                <Border Height="1" Background="{DynamicResource BorderDefault}"/>

                                                <!-- Enable Toggle and Actions -->
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                                                        <ToggleSwitch IsChecked="{Binding RuleEnabled}"
                                                                      OnContent="" OffContent=""/>
                                                        <TextBlock Text="Enable this rule"
                                                                   VerticalAlignment="Center"
                                                                   FontWeight="Medium"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                                        <Button Classes="secondary small"
                                                                Command="{Binding CancelEditCommand}">
                                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                                <LucideIcon Kind="X" Size="14"/>
                                                                <TextBlock Text="Cancel"/>
                                                            </StackPanel>
                                                        </Button>
                                                        <Button Classes="primary small"
                                                                Command="{Binding SaveRuleCommand}">
                                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                                <LucideIcon Kind="Save" Size="14"/>
                                                                <TextBlock Text="Save Rule"/>
                                                            </StackPanel>
                                                        </Button>
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>

                                <!-- Rules List -->
                                <Border Classes="card" Padding="0" Background="{DynamicResource SurfaceSubtle}"
                                        IsVisible="{Binding !IsAddingRule}">
                                    <StackPanel>
                                        <!-- Section Header with Add Button -->
                                        <Border Padding="16,14"
                                                BorderBrush="{DynamicResource BorderDefault}"
                                                BorderThickness="0,0,0,1"
                                                Background="{DynamicResource CardBackground}"
                                                CornerRadius="8,8,0,0">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                                                    <Border Width="28" Height="28"
                                                            CornerRadius="6"
                                                            Background="{DynamicResource SurfaceBrand}">
                                                        <LucideIcon Kind="Inbox" Size="16"
                                                                  Foreground="{DynamicResource AccentBrand}"/>
                                                    </Border>
                                                    <TextBlock Text="Configured Rules" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                                                </StackPanel>
                                                <Button Grid.Column="2"
                                                        Classes="primary small"
                                                        Command="{Binding ShowAddRuleCommand}">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <LucideIcon Kind="Plus" Size="14"/>
                                                        <TextBlock Text="Add Rule"/>
                                                    </StackPanel>
                                                </Button>
                                            </Grid>
                                        </Border>

                                        <!-- Rules Content -->
                                        <Border Padding="8">
                                            <!-- Empty State -->
                                            <StackPanel IsVisible="{Binding !Rules.Count}"
                                                        VerticalAlignment="Center"
                                                        HorizontalAlignment="Center"
                                                        Spacing="12"
                                                        Margin="0,24">
                                                <Border Width="64" Height="64"
                                                        CornerRadius="32"
                                                        Background="{DynamicResource SurfaceSubtle}"
                                                        HorizontalAlignment="Center"
                                                        BorderThickness="2"
                                                        BorderBrush="{DynamicResource BorderDefault}">
                                                    <LucideIcon Kind="Inbox" Size="28"
                                                              Foreground="{DynamicResource SubtleForeground}"/>
                                                </Border>
                                                <TextBlock Text="No rules configured"
                                                           FontSize="16"
                                                           FontWeight="SemiBold"
                                                           HorizontalAlignment="Center"/>
                                                <TextBlock Text="Add a rule to start monitoring your entities"
                                                           FontSize="13"
                                                           Foreground="{DynamicResource SubtleForeground}"
                                                           HorizontalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Rules List -->
                                        <ItemsControl ItemsSource="{Binding Rules}" Margin="8,0,8,8">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="models:AlertRule">
                                                    <Border Padding="16"
                                                            Margin="0,0,0,8"
                                                            CornerRadius="8"
                                                            Background="{DynamicResource CardBackground}"
                                                            BorderThickness="1"
                                                            BorderBrush="{DynamicResource BorderDefault}"
                                                            Opacity="{Binding !IsEnabled, Converter={StaticResource BoolToOpacityConverter}}">
                                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                                            <!-- Enable Toggle -->
                                                            <ToggleSwitch Grid.Column="0"
                                                                          IsChecked="{Binding IsEnabled}"
                                                                          Margin="0,0,16,0"
                                                                          OnContent="" OffContent=""
                                                                          VerticalAlignment="Center"/>

                                                            <!-- Rule Details -->
                                                            <StackPanel Grid.Column="1" Spacing="6" VerticalAlignment="Center">
                                                                <StackPanel Orientation="Horizontal" Spacing="10">
                                                                    <TextBlock Text="{Binding Name}"
                                                                               FontWeight="SemiBold"
                                                                               FontSize="14"/>
                                                                    <Border CornerRadius="4" Padding="8,3"
                                                                            Background="{Binding Severity, Converter={StaticResource SeverityToBackgroundConverter}}">
                                                                        <TextBlock Text="{Binding Severity}"
                                                                                   FontSize="11"
                                                                                   FontWeight="Medium"
                                                                                   Foreground="{Binding Severity, Converter={StaticResource SeverityToColorConverter}}"/>
                                                                    </Border>
                                                                </StackPanel>
                                                                <StackPanel Orientation="Horizontal" Spacing="16">
                                                                    <TextBlock FontSize="13" Foreground="{DynamicResource SubtleForeground}">
                                                                        <Run Text="{Binding Type}"/>
                                                                        <Run Text=" "/>
                                                                        <Run Text="&#8805;" FontFamily="Segoe UI Symbol"/>
                                                                        <Run Text=" "/>
                                                                        <Run Text="{Binding Threshold, StringFormat='{}{0:N0}'}" FontWeight="Medium"/>
                                                                    </TextBlock>
                                                                    <TextBlock Text="{Binding EntityPattern, StringFormat='{}Pattern: {0}'}"
                                                                               FontSize="12"
                                                                               Foreground="{DynamicResource MutedForeground}"
                                                                               IsVisible="{Binding EntityPattern, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                                                </StackPanel>
                                                            </StackPanel>

                                                            <!-- Actions -->
                                                            <StackPanel Grid.Column="2"
                                                                        Orientation="Horizontal"
                                                                        Spacing="2"
                                                                        VerticalAlignment="Center">
                                                                <Button Classes="subtle small"
                                                                        ToolTip.Tip="Test this rule"
                                                                        Command="{Binding $parent[ItemsControl].((vm:AlertsViewModel)DataContext).TestRuleCommand}"
                                                                        CommandParameter="{Binding}"
                                                                        Padding="8">
                                                                    <LucideIcon Kind="Radio" Size="16"/>
                                                                </Button>
                                                                <Button Classes="subtle small"
                                                                        ToolTip.Tip="Edit rule"
                                                                        Command="{Binding $parent[ItemsControl].((vm:AlertsViewModel)DataContext).ShowEditRuleCommand}"
                                                                        CommandParameter="{Binding}"
                                                                        Padding="8">
                                                                    <LucideIcon Kind="Pencil" Size="16"/>
                                                                </Button>
                                                                <Button Classes="danger-subtle small"
                                                                        ToolTip.Tip="Delete rule"
                                                                        Command="{Binding $parent[ItemsControl].((vm:AlertsViewModel)DataContext).DeleteRuleCommand}"
                                                                        CommandParameter="{Binding}"
                                                                        Padding="8">
                                                                    <LucideIcon Kind="Trash2" Size="16"/>
                                                                </Button>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Grid>
                    </Border>
                </ScrollViewer>

                <!-- Footer -->
                <Border Grid.Row="3"
                        BorderBrush="{DynamicResource BorderDefault}"
                        BorderThickness="0,1,0,0"
                        Padding="24,16"
                        Background="{DynamicResource CardBackground}">
                    <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                        <ToggleSwitch IsChecked="{Binding SystemNotificationsEnabled}"
                                      OnContent="" OffContent=""/>
                        <StackPanel Spacing="2">
                            <TextBlock Text="System notifications" FontWeight="Medium" FontSize="13"/>
                            <TextBlock Text="Get desktop alerts when rules trigger"
                                       Classes="caption" FontSize="11"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Border>
</UserControl>
