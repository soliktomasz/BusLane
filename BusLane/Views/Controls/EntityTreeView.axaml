<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BusLane.ViewModels"
             xmlns:models="using:BusLane.Models"
             xmlns:converters="using:BusLane.Converters"
             x:Class="BusLane.Views.Controls.EntityTreeView"
             x:DataType="vm:MainWindowViewModel">

    <UserControl.Resources>
        <converters:EntitySelectionConverter x:Key="EntitySelectionConverter"/>
        <converters:EntitySelectionBackgroundConverter x:Key="EntitySelectionBackgroundConverter"/>
        <converters:DeadLetterBadgeVisibilityConverter x:Key="DeadLetterBadgeVisibilityConverter"/>
    </UserControl.Resources>

    <Border Classes="card" Padding="0">
        <DockPanel>
            <!-- Header -->
            <Border DockPanel.Dock="Top" Padding="16,14,16,12" Background="{DynamicResource SurfaceSubtle}">
                <StackPanel Spacing="2">
                    <TextBlock Text="Entities" FontSize="14" FontWeight="SemiBold"/>
                    <TextBlock Text="Queues, topics and subscriptions" FontSize="11"
                               Foreground="{DynamicResource SubtleForeground}"/>
                </StackPanel>
            </Border>

            <ScrollViewer>
                <StackPanel Spacing="16" Margin="12,12,12,16">
                    <!-- Queues Section -->
                    <StackPanel IsVisible="{Binding CurrentNavigation.HasQueues}" Spacing="6">
                        <!-- Section Header -->
                        <Grid ColumnDefinitions="Auto,*,Auto" Margin="4,0">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <Border Width="24" Height="24" CornerRadius="4"
                                        Background="{DynamicResource SurfaceBrand}">
                                    <PathIcon Data="{StaticResource IconQueue}" Width="12" Height="12"
                                              Foreground="{DynamicResource AccentBrand}"
                                              HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <TextBlock Text="Queues" FontSize="12" FontWeight="SemiBold"
                                           VerticalAlignment="Center" Foreground="{DynamicResource AppForeground}"/>
                            </StackPanel>
                            <Border Grid.Column="2" Background="{DynamicResource SurfaceSubtle}"
                                    CornerRadius="10" Padding="8,2" VerticalAlignment="Center">
                                <TextBlock Text="{Binding CurrentNavigation.Queues.Count}" FontSize="10" FontWeight="SemiBold"
                                           Foreground="{DynamicResource SubtleForeground}"/>
                            </Border>
                        </Grid>

                        <!-- Loading indicator -->
                        <Border IsVisible="{Binding IsLoading}"
                                Padding="10,6"
                                Background="{DynamicResource SurfaceSubtle}"
                                CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <ProgressBar IsIndeterminate="True" Width="50" Height="2" />
                                <TextBlock Text="Loading queues..." FontSize="11"
                                           Foreground="{DynamicResource SubtleForeground}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>

                        <!-- Queue List -->
                        <ListBox ItemsSource="{Binding CurrentNavigation.Queues}"
                                 Classes="entity-list"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <VirtualizingStackPanel/>
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="models:QueueInfo">
                                    <Button Classes="subtle"
                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectQueueForConnectionCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Stretch"
                                            Padding="0"
                                            Margin="0,1">
                                        <Grid ColumnDefinitions="3,*">
                                            <!-- Selection indicator -->
                                            <Border Grid.Column="0"
                                                    Background="{DynamicResource AccentBrand}"
                                                    CornerRadius="2"
                                                    Margin="0,6">
                                                <Border.IsVisible>
                                                    <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                        <Binding Path="."/>
                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedQueue"/>
                                                    </MultiBinding>
                                                </Border.IsVisible>
                                            </Border>

                                            <!-- Content -->
                                            <Border Grid.Column="1" Padding="10,8" CornerRadius="4" Margin="4,0,0,0">
                                                <Border.Background>
                                                    <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                        <Binding Path="."/>
                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedQueue"/>
                                                    </MultiBinding>
                                                </Border.Background>
                                                <Grid ColumnDefinitions="Auto,*">
                                                    <!-- Icon -->
                                                    <Border Grid.Column="0" Width="28" Height="28" CornerRadius="4"
                                                            Background="{DynamicResource AccentBrand}" Margin="0,0,10,0">
                                                        <TextBlock Text="Q" FontWeight="SemiBold" FontSize="12"
                                                                   Foreground="{DynamicResource TextOnBrand}"
                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                                                        <TextBlock Text="{Binding Name}" FontSize="12" FontWeight="Medium"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                        <!-- Counters -->
                                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                                            <Border Background="{DynamicResource SurfaceBrand}"
                                                                    CornerRadius="3" Padding="5,2">
                                                                <TextBlock FontSize="10" Foreground="{DynamicResource AccentBrand}">
                                                                    <Run Text="{Binding ActiveMessageCount}"/><Run Text=" active"/>
                                                                </TextBlock>
                                                            </Border>
                                                            <Border Background="{DynamicResource SurfaceDanger}"
                                                                    CornerRadius="3" Padding="5,2">
                                                                <Border.IsVisible>
                                                                    <MultiBinding Converter="{StaticResource DeadLetterBadgeVisibilityConverter}">
                                                                        <Binding Path="DeadLetterCount"/>
                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).ShowDeadLetterBadges"/>
                                                                    </MultiBinding>
                                                                </Border.IsVisible>
                                                                <TextBlock FontSize="10" Foreground="{DynamicResource TextDanger}">
                                                                    <Run Text="{Binding DeadLetterCount}"/><Run Text=" dlq"/>
                                                                </TextBlock>
                                                            </Border>
                                                            <Border Background="{DynamicResource SurfaceWarning}"
                                                                    CornerRadius="3" Padding="5,2"
                                                                    IsVisible="{Binding ScheduledCount}">
                                                                <TextBlock FontSize="10" Foreground="{DynamicResource TextWarning}">
                                                                    <Run Text="{Binding ScheduledCount}"/><Run Text=" sched"/>
                                                                </TextBlock>
                                                            </Border>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </StackPanel>

                    <!-- Divider -->
                    <Border Height="1" Background="{DynamicResource BorderDefault}"
                            IsVisible="{Binding CurrentNavigation.HasQueues}" Margin="4,0"/>

                    <!-- Topics Section -->
                    <StackPanel IsVisible="{Binding CurrentNavigation.HasTopics}" Spacing="6">
                        <!-- Section Header -->
                        <Grid ColumnDefinitions="Auto,*,Auto" Margin="4,0">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <Border Width="24" Height="24" CornerRadius="4"
                                        Background="{DynamicResource SurfaceSuccess}">
                                    <PathIcon Data="{StaticResource IconTopic}" Width="12" Height="12"
                                              Foreground="{DynamicResource TextSuccess}"
                                              HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <TextBlock Text="Topics" FontSize="12" FontWeight="SemiBold"
                                           VerticalAlignment="Center" Foreground="{DynamicResource AppForeground}"/>
                            </StackPanel>
                            <Border Grid.Column="2" Background="{DynamicResource SurfaceSubtle}"
                                    CornerRadius="10" Padding="8,2" VerticalAlignment="Center">
                                <TextBlock Text="{Binding CurrentNavigation.Topics.Count}" FontSize="10" FontWeight="SemiBold"
                                           Foreground="{DynamicResource SubtleForeground}"/>
                            </Border>
                        </Grid>

                        <!-- Loading indicator -->
                        <Border IsVisible="{Binding IsLoading}"
                                Padding="10,6"
                                Background="{DynamicResource SurfaceSubtle}"
                                CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <ProgressBar IsIndeterminate="True" Width="50" Height="2" />
                                <TextBlock Text="Loading topics..." FontSize="11"
                                           Foreground="{DynamicResource SubtleForeground}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>

                        <!-- Topic List -->
                        <ListBox ItemsSource="{Binding CurrentNavigation.Topics}"
                                 Classes="entity-list"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <VirtualizingStackPanel/>
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="models:TopicInfo">
                                    <Expander Margin="0,1" IsExpanded="False" Expanding="OnTopicExpanderExpanding">
                                        <Expander.Header>
                                            <Button Classes="subtle"
                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectTopicForConnectionCommand}"
                                                    CommandParameter="{Binding}"
                                                    HorizontalAlignment="Stretch"
                                                    HorizontalContentAlignment="Stretch"
                                                    Padding="0">
                                                <Grid ColumnDefinitions="3,*">
                                                    <!-- Selection indicator -->
                                                    <Border Grid.Column="0"
                                                            Background="{DynamicResource TextSuccess}"
                                                            CornerRadius="2"
                                                            Margin="0,6">
                                                        <Border.IsVisible>
                                                            <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                <Binding Path="."/>
                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedTopic"/>
                                                            </MultiBinding>
                                                        </Border.IsVisible>
                                                    </Border>

                                                    <!-- Content -->
                                                    <Border Grid.Column="1" Padding="10,8" CornerRadius="4" Margin="4,0,0,0">
                                                        <Border.Background>
                                                            <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                <Binding Path="."/>
                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedTopic"/>
                                                            </MultiBinding>
                                                        </Border.Background>
                                                        <Grid ColumnDefinitions="Auto,*">
                                                            <!-- Icon -->
                                                            <Border Grid.Column="0" Width="28" Height="28" CornerRadius="4"
                                                                    Background="{DynamicResource TextSuccess}" Margin="0,0,10,0">
                                                                <TextBlock Text="T" FontWeight="SemiBold" FontSize="12"
                                                                           Foreground="{DynamicResource TextOnBrand}"
                                                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                            </Border>
                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="3">
                                                                <TextBlock Text="{Binding Name}" FontSize="12" FontWeight="Medium"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                                <TextBlock Text="{Binding SubscriptionCount, StringFormat='{}{0} subscriptions'}"
                                                                           FontSize="10" Foreground="{DynamicResource SubtleForeground}"/>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </Grid>
                                            </Button>
                                        </Expander.Header>

                                        <!-- Subscriptions -->
                                        <StackPanel Margin="24,4,0,8">
                                            <!-- Loading indicator -->
                                            <Border IsVisible="{Binding IsLoadingSubscriptions}"
                                                    Padding="8,4"
                                                    Background="{DynamicResource SurfaceSubtle}"
                                                    CornerRadius="4"
                                                    Margin="0,0,0,4">
                                                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                                    <ProgressBar IsIndeterminate="True" Width="40" Height="2" />
                                                    <TextBlock Text="Loading..." FontSize="10"
                                                               Foreground="{DynamicResource SubtleForeground}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>

                                            <!-- Subscription List -->
                                            <ListBox ItemsSource="{Binding Subscriptions}"
                                                     Classes="entity-list"
                                                     Background="Transparent"
                                                     BorderThickness="0"
                                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                                <ListBox.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <VirtualizingStackPanel/>
                                                    </ItemsPanelTemplate>
                                                </ListBox.ItemsPanel>
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate x:DataType="models:SubscriptionInfo">
                                                        <Button Classes="subtle"
                                                                Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectSubscriptionForConnectionCommand}"
                                                                CommandParameter="{Binding}"
                                                                HorizontalAlignment="Stretch"
                                                                HorizontalContentAlignment="Stretch"
                                                                Padding="0"
                                                                Margin="0,1">
                                                            <Grid ColumnDefinitions="3,*">
                                                                <!-- Selection indicator -->
                                                                <Border Grid.Column="0"
                                                                        Background="{DynamicResource TextWarning}"
                                                                        CornerRadius="2"
                                                                        Margin="0,4">
                                                                    <Border.IsVisible>
                                                                        <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                            <Binding Path="."/>
                                                                            <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedSubscription"/>
                                                                        </MultiBinding>
                                                                    </Border.IsVisible>
                                                                </Border>

                                                                <!-- Content -->
                                                                <Border Grid.Column="1" Padding="8,6" CornerRadius="4" Margin="4,0,0,0"
                                                                        BorderThickness="1" BorderBrush="{DynamicResource BorderDefault}">
                                                                    <Border.Background>
                                                                        <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                            <Binding Path="."/>
                                                                            <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedSubscription"/>
                                                                        </MultiBinding>
                                                                    </Border.Background>
                                                                    <Grid ColumnDefinitions="Auto,*">
                                                                        <!-- Icon -->
                                                                        <Border Grid.Column="0" Width="22" Height="22" CornerRadius="3"
                                                                                Background="{DynamicResource TextWarning}" Margin="0,0,8,0">
                                                                            <TextBlock Text="S" FontWeight="SemiBold" FontSize="10"
                                                                                       Foreground="{DynamicResource TextOnBrand}"
                                                                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                        </Border>
                                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="3">
                                                                            <TextBlock Text="{Binding Name}" FontSize="11" FontWeight="Medium"
                                                                                       TextTrimming="CharacterEllipsis"/>
                                                                            <!-- Counters -->
                                                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                <Border Background="{DynamicResource SurfaceBrand}"
                                                                                        CornerRadius="2" Padding="4,1">
                                                                                    <TextBlock FontSize="9" Foreground="{DynamicResource AccentBrand}">
                                                                                        <Run Text="{Binding ActiveMessageCount}"/><Run Text=" active"/>
                                                                                    </TextBlock>
                                                                                </Border>
                                                                                <Border Background="{DynamicResource SurfaceDanger}"
                                                                                        CornerRadius="2" Padding="4,1">
                                                                                    <Border.IsVisible>
                                                                                        <MultiBinding Converter="{StaticResource DeadLetterBadgeVisibilityConverter}">
                                                                                            <Binding Path="DeadLetterCount"/>
                                                                                            <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).ShowDeadLetterBadges"/>
                                                                                        </MultiBinding>
                                                                                    </Border.IsVisible>
                                                                                    <TextBlock FontSize="9" Foreground="{DynamicResource TextDanger}">
                                                                                        <Run Text="{Binding DeadLetterCount}"/><Run Text=" dlq"/>
                                                                                    </TextBlock>
                                                                                </Border>
                                                                            </StackPanel>
                                                                        </StackPanel>
                                                                    </Grid>
                                                                </Border>
                                                            </Grid>
                                                        </Button>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </StackPanel>
                                    </Expander>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </DockPanel>
    </Border>
</UserControl>

