<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BusLane.ViewModels"
             xmlns:models="using:BusLane.Models"
             xmlns:converters="using:BusLane.Converters"
             x:Class="BusLane.Views.Controls.AzureEntityTreeView"
             x:DataType="vm:MainWindowViewModel">

    <UserControl.Resources>
        <converters:EntitySelectionConverter x:Key="EntitySelectionConverter"/>
        <converters:EntitySelectionBackgroundConverter x:Key="EntitySelectionBackgroundConverter"/>
        <converters:DeadLetterBadgeVisibilityConverter x:Key="DeadLetterBadgeVisibilityConverter"/>
    </UserControl.Resources>

    <Border Classes="card" Padding="0">
        <DockPanel>
            <!-- Search/Filter Bar -->
            <Border DockPanel.Dock="Top" Padding="10,10,10,8"
                    Background="{DynamicResource SurfaceSubtle}"
                    BorderBrush="{DynamicResource BorderMuted}"
                    BorderThickness="0,0,0,1">
                <TextBox Text="{Binding CurrentNavigation.EntityFilter, Mode=TwoWay}"
                         Watermark="Filter entities..."
                         FontSize="12"
                         Padding="6,6,6,6"
                         CornerRadius="6"
                         BorderBrush="{DynamicResource BorderMuted}">
                    <TextBox.InnerLeftContent>
                        <LucideIcon Kind="Search" Size="14"
                                    Foreground="{DynamicResource SubtleForeground}"
                                    Margin="6,0,0,0"/>
                    </TextBox.InnerLeftContent>
                </TextBox>
            </Border>

            <ScrollViewer>
                <StackPanel Spacing="0" Margin="0,4,0,8">
                    <!-- Queues Section -->
                    <Expander IsExpanded="{Binding CurrentNavigation.IsQueuesSectionExpanded}"
                              Margin="6,2,6,0">
                        <Expander.Header>
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                    <Border Width="22" Height="22" CornerRadius="4"
                                            Background="{DynamicResource SurfaceBrand}"
                                            BorderThickness="1" BorderBrush="{DynamicResource BorderMuted}">
                                        <LucideIcon Kind="ListOrdered" Size="12"
                                                    Foreground="{DynamicResource AccentBrand}"
                                                    HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <TextBlock Text="Queues" FontSize="12" FontWeight="SemiBold"
                                               VerticalAlignment="Center" Foreground="{DynamicResource AppForeground}"/>
                                </StackPanel>
                                <Border Grid.Column="2" Background="{DynamicResource SurfaceSubtle}"
                                        CornerRadius="10" Padding="7,2" VerticalAlignment="Center"
                                        BorderThickness="1" BorderBrush="{DynamicResource BorderMuted}">
                                    <TextBlock Text="{Binding CurrentNavigation.Queues.Count}" FontSize="10" FontWeight="SemiBold"
                                               Foreground="{DynamicResource SubtleForeground}"/>
                                </Border>
                            </Grid>
                        </Expander.Header>

                        <StackPanel Spacing="0">
                            <!-- Loading indicator -->
                            <Border IsVisible="{Binding IsLoading}"
                                    Padding="10,6"
                                    Background="{DynamicResource SurfaceSubtle}"
                                    CornerRadius="4"
                                    Margin="4,4,4,2">
                                <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                    <ProgressBar IsIndeterminate="True" Width="50" Height="2" />
                                    <TextBlock Text="Loading queues..." FontSize="11"
                                               Foreground="{DynamicResource SubtleForeground}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Queue List -->
                            <ListBox ItemsSource="{Binding CurrentNavigation.FilteredQueues}"
                                     Classes="entity-list"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel/>
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.ItemTemplate>
                                    <DataTemplate x:DataType="models:QueueInfo">
                                        <Button Classes="subtle"
                                                Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectQueueCommand}"
                                                CommandParameter="{Binding}"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Stretch"
                                                Padding="0"
                                                Margin="0,1">
                                            <Grid ColumnDefinitions="3,*">
                                                <!-- Selection indicator -->
                                                <Border Grid.Column="0"
                                                        Background="{DynamicResource AccentBrand}"
                                                        CornerRadius="1.5"
                                                        Width="3"
                                                        Margin="0,6"
                                                        HorizontalAlignment="Left">
                                                    <Border.IsVisible>
                                                        <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                            <Binding Path="."/>
                                                            <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedQueue"/>
                                                        </MultiBinding>
                                                    </Border.IsVisible>
                                                </Border>

                                                <!-- Content -->
                                                <Border Grid.Column="1" Padding="8,6" CornerRadius="4" Margin="4,0,0,0">
                                                    <Border.Background>
                                                        <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                            <Binding Path="."/>
                                                            <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedQueue"/>
                                                        </MultiBinding>
                                                    </Border.Background>
                                                    <Grid ColumnDefinitions="*,Auto">
                                                        <!-- Name -->
                                                        <TextBlock Grid.Column="0" Text="{Binding Name}"
                                                                   FontSize="12" FontWeight="Medium"
                                                                   Foreground="{DynamicResource AppForeground}"
                                                                   VerticalAlignment="Center"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   Margin="0,0,8,0"/>

                                                        <!-- Counters (inline) -->
                                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4"
                                                                    VerticalAlignment="Center">
                                                            <Border Background="{DynamicResource SurfaceBrand}"
                                                                    CornerRadius="3" Padding="5,2"
                                                                    IsVisible="{Binding ActiveMessageCount}">
                                                                <TextBlock FontSize="10" FontWeight="Medium"
                                                                           Foreground="{DynamicResource AccentBrand}"
                                                                           Text="{Binding ActiveMessageCount}"/>
                                                            </Border>
                                                            <Border Background="{DynamicResource SurfaceDanger}"
                                                                    CornerRadius="3" Padding="5,2">
                                                                <Border.IsVisible>
                                                                    <MultiBinding Converter="{StaticResource DeadLetterBadgeVisibilityConverter}">
                                                                        <Binding Path="DeadLetterCount"/>
                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).ShowDeadLetterBadges"/>
                                                                    </MultiBinding>
                                                                </Border.IsVisible>
                                                                <TextBlock FontSize="10" FontWeight="Medium" Foreground="{DynamicResource TextDanger}">
                                                                    <Run Text="{Binding DeadLetterCount}"/><Run Text=" dlq"/>
                                                                </TextBlock>
                                                            </Border>
                                                            <Border Background="{DynamicResource SurfaceWarning}"
                                                                    CornerRadius="3" Padding="5,2"
                                                                    IsVisible="{Binding ScheduledCount}">
                                                                <TextBlock FontSize="10" FontWeight="Medium" Foreground="{DynamicResource TextWarning}">
                                                                    <Run Text="{Binding ScheduledCount}"/><Run Text=" sch"/>
                                                                </TextBlock>
                                                            </Border>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </Grid>
                                        </Button>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </Expander>

                    <!-- Divider -->
                    <Border Height="1" Background="{DynamicResource BorderDefault}" Margin="10,6"/>

                    <!-- Topics Section -->
                    <Expander IsExpanded="{Binding CurrentNavigation.IsTopicsSectionExpanded}"
                              Margin="6,0,6,0">
                        <Expander.Header>
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                    <Border Width="22" Height="22" CornerRadius="4"
                                            Background="{DynamicResource SurfaceSuccess}"
                                            BorderThickness="1" BorderBrush="{DynamicResource BorderMuted}">
                                        <LucideIcon Kind="Megaphone" Size="12"
                                                    Foreground="{DynamicResource TextSuccess}"
                                                    HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <TextBlock Text="Topics" FontSize="12" FontWeight="SemiBold"
                                               VerticalAlignment="Center" Foreground="{DynamicResource AppForeground}"/>
                                </StackPanel>
                                <Border Grid.Column="2" Background="{DynamicResource SurfaceSubtle}"
                                        CornerRadius="10" Padding="7,2" VerticalAlignment="Center"
                                        BorderThickness="1" BorderBrush="{DynamicResource BorderMuted}">
                                    <TextBlock Text="{Binding CurrentNavigation.Topics.Count}" FontSize="10" FontWeight="SemiBold"
                                               Foreground="{DynamicResource SubtleForeground}"/>
                                </Border>
                            </Grid>
                        </Expander.Header>

                        <StackPanel Spacing="0">
                            <!-- Loading indicator -->
                            <Border IsVisible="{Binding IsLoading}"
                                    Padding="10,6"
                                    Background="{DynamicResource SurfaceSubtle}"
                                    CornerRadius="4"
                                    Margin="4,4,4,2">
                                <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                    <ProgressBar IsIndeterminate="True" Width="50" Height="2" />
                                    <TextBlock Text="Loading topics..." FontSize="11"
                                               Foreground="{DynamicResource SubtleForeground}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Topic List -->
                            <ListBox ItemsSource="{Binding CurrentNavigation.FilteredTopics}"
                                     Classes="entity-list"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel/>
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.ItemTemplate>
                                    <DataTemplate x:DataType="models:TopicInfo">
                                        <Expander Margin="0,1" IsExpanded="{Binding IsExpanded}" Expanding="OnTopicExpanderExpanding">
                                            <Expander.Header>
                                                <Grid ColumnDefinitions="3,*" PointerPressed="OnTopicHeaderTapped">
                                                    <!-- Selection indicator -->
                                                    <Border Grid.Column="0"
                                                            Background="{DynamicResource TextSuccess}"
                                                            CornerRadius="1.5"
                                                            Width="3"
                                                            Margin="0,6"
                                                            HorizontalAlignment="Left">
                                                        <Border.IsVisible>
                                                            <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                <Binding Path="."/>
                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedTopic"/>
                                                            </MultiBinding>
                                                        </Border.IsVisible>
                                                    </Border>

                                                    <!-- Content -->
                                                    <Border Grid.Column="1" Padding="8,6" CornerRadius="4" Margin="4,0,0,0">
                                                        <Border.Background>
                                                            <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                <Binding Path="."/>
                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedTopic"/>
                                                            </MultiBinding>
                                                        </Border.Background>
                                                        <Grid ColumnDefinitions="*,Auto">
                                                            <TextBlock Grid.Column="0" Text="{Binding Name}"
                                                                       FontSize="12" FontWeight="Medium"
                                                                       Foreground="{DynamicResource AppForeground}"
                                                                       VerticalAlignment="Center"
                                                                       TextTrimming="CharacterEllipsis"
                                                                       Margin="0,0,8,0"/>
                                                            <Border Grid.Column="1" Background="{DynamicResource SurfaceSubtle}"
                                                                    CornerRadius="3" Padding="5,2" VerticalAlignment="Center"
                                                                    BorderThickness="1" BorderBrush="{DynamicResource BorderMuted}">
                                                                <TextBlock FontSize="10" FontWeight="Medium" Foreground="{DynamicResource SubtleForeground}">
                                                                    <Run Text="{Binding SubscriptionCount}"/><Run Text=" subs"/>
                                                                </TextBlock>
                                                            </Border>
                                                        </Grid>
                                                    </Border>
                                                </Grid>
                                            </Expander.Header>

                                            <!-- Subscriptions -->
                                            <Grid ColumnDefinitions="Auto,*" Margin="12,4,4,4">
                                                <!-- Tree connector line -->
                                                <Border Grid.Column="0" Width="1"
                                                        Background="{DynamicResource BorderDefault}"
                                                        VerticalAlignment="Stretch"
                                                        Margin="4,0,0,0"/>

                                                <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                                    <!-- Loading indicator -->
                                                    <Border IsVisible="{Binding IsLoadingSubscriptions}"
                                                            Padding="8,4"
                                                            Background="{DynamicResource SurfaceSubtle}"
                                                            CornerRadius="4"
                                                            Margin="0,0,0,2">
                                                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                                            <ProgressBar IsIndeterminate="True" Width="40" Height="2" />
                                                            <TextBlock Text="Loading..." FontSize="10"
                                                                       Foreground="{DynamicResource SubtleForeground}" VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                    </Border>

                                                    <!-- Subscription List -->
                                                    <ListBox ItemsSource="{Binding Subscriptions}"
                                                             Classes="entity-list"
                                                             Background="Transparent"
                                                             BorderThickness="0"
                                                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                                        <ListBox.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <VirtualizingStackPanel/>
                                                            </ItemsPanelTemplate>
                                                        </ListBox.ItemsPanel>
                                                        <ListBox.ItemTemplate>
                                                            <DataTemplate x:DataType="models:SubscriptionInfo">
                                                                <Button Classes="subtle"
                                                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectSubscriptionCommand}"
                                                                        CommandParameter="{Binding}"
                                                                        HorizontalAlignment="Stretch"
                                                                        HorizontalContentAlignment="Stretch"
                                                                        Padding="0"
                                                                        Margin="0,5">
                                                                    <Grid ColumnDefinitions="3,*">
                                                                        <!-- Selection indicator -->
                                                                        <Border Grid.Column="0"
                                                                                Background="{DynamicResource TextWarning}"
                                                                                CornerRadius="1.5"
                                                                                Width="3"
                                                                                Margin="0,6"
                                                                                HorizontalAlignment="Left">
                                                                            <Border.IsVisible>
                                                                                <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                                    <Binding Path="."/>
                                                                                    <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedSubscription"/>
                                                                                </MultiBinding>
                                                                            </Border.IsVisible>
                                                                        </Border>

                                                                        <!-- Content -->
                                                                        <Border Grid.Column="1" Padding="8,6" CornerRadius="4" Margin="4,0,0,0">
                                                                            <Border.Background>
                                                                                <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                                    <Binding Path="."/>
                                                                                    <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).CurrentNavigation.SelectedSubscription"/>
                                                                                </MultiBinding>
                                                                            </Border.Background>
                                                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                                                <!-- Subscription icon -->
                                                                                <LucideIcon Grid.Column="0" Kind="Inbox" Size="14"
                                                                                            Foreground="{DynamicResource TextWarning}"
                                                                                            VerticalAlignment="Center"
                                                                                            Margin="0,0,8,0"/>

                                                                                <!-- Name -->
                                                                                <TextBlock Grid.Column="1" Text="{Binding Name}"
                                                                                           FontSize="12" FontWeight="Medium"
                                                                                           Foreground="{DynamicResource AppForeground}"
                                                                                           VerticalAlignment="Center"
                                                                                           TextTrimming="CharacterEllipsis"
                                                                                           Margin="0,0,8,0"/>

                                                                                <!-- Counters (inline) -->
                                                                                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4"
                                                                                            VerticalAlignment="Center">
                                                                                    <Border Background="{DynamicResource SurfaceBrand}"
                                                                                            CornerRadius="3" Padding="5,2"
                                                                                            IsVisible="{Binding ActiveMessageCount}">
                                                                                        <TextBlock FontSize="10" FontWeight="Medium"
                                                                                                   Foreground="{DynamicResource AccentBrand}"
                                                                                                   Text="{Binding ActiveMessageCount}"/>
                                                                                    </Border>
                                                                                    <Border Background="{DynamicResource SurfaceDanger}"
                                                                                            CornerRadius="3" Padding="5,2">
                                                                                        <Border.IsVisible>
                                                                                            <MultiBinding Converter="{StaticResource DeadLetterBadgeVisibilityConverter}">
                                                                                                <Binding Path="DeadLetterCount"/>
                                                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).ShowDeadLetterBadges"/>
                                                                                            </MultiBinding>
                                                                                        </Border.IsVisible>
                                                                                        <TextBlock FontSize="10" FontWeight="Medium" Foreground="{DynamicResource TextDanger}">
                                                                                            <Run Text="{Binding DeadLetterCount}"/><Run Text=" dlq"/>
                                                                                        </TextBlock>
                                                                                    </Border>
                                                                                </StackPanel>
                                                                            </Grid>
                                                                        </Border>
                                                                    </Grid>
                                                                </Button>
                                                            </DataTemplate>
                                                        </ListBox.ItemTemplate>
                                                    </ListBox>
                                                </StackPanel>
                                            </Grid>
                                        </Expander>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>
        </DockPanel>
    </Border>
</UserControl>
