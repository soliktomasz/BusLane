<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:BusLane.ViewModels"
        xmlns:models="using:BusLane.Models"
        xmlns:converters="using:BusLane.Converters"
        x:Class="BusLane.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Bus Lane - Service Bus Manager"
        Width="1280" Height="800"
        MinWidth="1000" MinHeight="600"
        WindowStartupLocation="CenterScreen">
    
    <Window.Resources>
        <converters:EntitySelectionConverter x:Key="EntitySelectionConverter"/>
        <converters:EntitySelectionBackgroundConverter x:Key="EntitySelectionBackgroundConverter"/>
    </Window.Resources>
    
    <Grid ColumnDefinitions="Auto,*">
        <!-- Navigation Pane (Fluent 2 Sidebar) -->
        <Border Grid.Column="0" Classes="sidebar">
            <DockPanel>
                <!-- App Header -->
                <StackPanel DockPanel.Dock="Top" Margin="16,20,16,12">
                    <TextBlock Text="Bus Lane" Classes="title"/>
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                        <TextBlock Text="Service Bus Manager" Classes="caption"/>
                        <TextBlock Text="{Binding AppVersion}" Classes="caption" Foreground="#0F6CBD"/>
                    </StackPanel>
                </StackPanel>
                
                <Separator DockPanel.Dock="Top" Margin="16,0"/>
                
                <!-- Action Buttons -->
                <StackPanel DockPanel.Dock="Top" Margin="12,12,12,12" Spacing="8">
                    <!-- Connection Library Button (always visible) -->
                    <Button Classes="primary" 
                            Content="My Connections"
                            Command="{Binding OpenConnectionLibraryCommand}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"/>
                    
                    <!-- Azure Sign In (when not authenticated and not using connection string) -->
                    <Button Classes="secondary" 
                            Content="Sign in with Azure"
                            Command="{Binding LoginCommand}"
                            IsVisible="{Binding !IsAuthenticated}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"/>
                    
                    <!-- Sign Out (when authenticated with Azure) -->
                    <Button Classes="secondary" 
                            Content="Sign Out"
                            Command="{Binding LogoutCommand}"
                            IsVisible="{Binding IsAuthenticated}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"/>
                </StackPanel>
                
                <!-- Settings Button - Docked to bottom -->
                <Button DockPanel.Dock="Bottom"
                        Classes="subtle" 
                        Command="{Binding OpenSettingsCommand}"
                        HorizontalAlignment="Stretch"
                        Margin="12,8,12,12"
                        Padding="12,8">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="âš™" FontSize="16" VerticalAlignment="Center"/>
                        <TextBlock Text="Settings" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                
                <!-- Active Connection Card (when using connection string) - Docked to bottom -->
                <Border DockPanel.Dock="Bottom" Margin="12,12,12,16"
                        IsVisible="{Binding ActiveConnection, Converter={x:Static ObjectConverters.IsNotNull}}"
                        Classes="card" Padding="0">
                    <StackPanel>
                        <!-- Connection Info -->
                        <Border Background="#FAFAFA" CornerRadius="8,8,0,0" Padding="16,12" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                            <StackPanel>
                                <TextBlock Text="Connected to" Classes="caption"/>
                                <TextBlock Text="{Binding ActiveConnection.Name}" 
                                           FontWeight="SemiBold" 
                                           FontSize="14" 
                                           Margin="0,4,0,0"/>
                                <TextBlock Text="{Binding ActiveConnection.EntityName}" 
                                           Classes="caption" 
                                           Margin="0,2,0,0"
                                           IsVisible="{Binding ActiveConnection.EntityName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                
                                <!-- Dead Letter Count Badge -->
                                <Border Classes="badge-danger" Padding="8,4" Margin="0,8,0,0"
                                        HorizontalAlignment="Left"
                                        IsVisible="{Binding HasDeadLetters}">
                                    <TextBlock Text="{Binding TotalDeadLetterCount, StringFormat='{}{0} Dead Letters'}"
                                               Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                                </Border>
                            </StackPanel>
                        </Border>
                        
                        <!-- Disconnect Button -->
                        <Button Classes="danger-outline" 
                                Content="Disconnect"
                                Command="{Binding DisconnectConnectionCommand}"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Margin="12"
                                Padding="12,6"/>
                    </StackPanel>
                </Border>
                
                <!-- Subscription Picker -->
                <StackPanel DockPanel.Dock="Top" Margin="12,0,12,12"
                            IsVisible="{Binding IsAuthenticated}">
                    <TextBlock Text="Subscription" Classes="caption" Margin="4,0,0,6"/>
                    <ComboBox ItemsSource="{Binding Subscriptions}"
                              SelectedItem="{Binding SelectedAzureSubscription}"
                              HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="models:AzureSubscription">
                                <TextBlock Text="{Binding Name}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>
                
                <!-- Namespaces Section -->
                <TextBlock DockPanel.Dock="Top" Text="Namespaces" 
                           Classes="body-strong" Margin="16,8,0,8"
                           IsVisible="{Binding IsAuthenticated}"/>
                
                <ScrollViewer IsVisible="{Binding IsAuthenticated}">
                    <ListBox ItemsSource="{Binding Namespaces}"
                             Margin="8,0">
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="models:ServiceBusNamespace">
                                <StackPanel>
                                    <Button Classes="subtle" 
                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectNamespaceCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Padding="8,6">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"/>
                                            <TextBlock Text="{Binding Location}" Classes="caption" FontSize="11" Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </ScrollViewer>
            </DockPanel>
        </Border>
        
        <!-- Main Content -->
        <Grid Grid.Column="1" Margin="24,20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Welcome / Not Connected -->
            <StackPanel Grid.Row="1" 
                        VerticalAlignment="Center" 
                        HorizontalAlignment="Center"
                        MaxWidth="480">
                <!-- Show when not authenticated and no active connection -->
                <StackPanel IsVisible="{Binding !IsAuthenticated}">
                    <StackPanel IsVisible="{Binding ActiveConnection, Converter={x:Static ObjectConverters.IsNull}}">
                        <TextBlock Text="Welcome to Bus Lane" Classes="title-large" HorizontalAlignment="Center"/>
                        <TextBlock Text="Connect using a connection string or sign in with your Azure account to manage your Service Bus resources." 
                                   Classes="subtitle" HorizontalAlignment="Center" Margin="0,12,0,24" TextWrapping="Wrap" TextAlignment="Center"/>
                        
                        <!-- Quick Actions -->
                        <StackPanel Spacing="12" HorizontalAlignment="Center">
                            <Button Classes="primary" 
                                    Content="Open Connection Library"
                                    Command="{Binding OpenConnectionLibraryCommand}"
                                    HorizontalAlignment="Center"
                                    Padding="20,10"/>
                        </StackPanel>
                        
                        <!-- Saved Connections Preview -->
                        <StackPanel Margin="0,32,0,0" IsVisible="{Binding SavedConnections.Count}">
                            <TextBlock Text="Recent Connections" Classes="body-strong" HorizontalAlignment="Center" Margin="0,0,0,12"/>
                            <ItemsControl ItemsSource="{Binding SavedConnections}" MaxHeight="200">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:SavedConnection">
                                        <Button Classes="secondary" 
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Left"
                                                Margin="0,0,0,8"
                                                Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ConnectToSavedConnectionCommand}"
                                                CommandParameter="{Binding}">
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <Border Classes="surface-brand" Padding="8" CornerRadius="4">
                                                    <TextBlock Text="â†—" FontSize="14" Foreground="#0F6CBD" VerticalAlignment="Center"/>
                                                </Border>
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"/>
                                                    <TextBlock Text="{Binding EntityName}" Classes="caption" FontSize="11"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
            
            <!-- Content when namespace selected (Azure mode) -->
            <Grid Grid.Row="0" Grid.RowSpan="2" 
                  IsVisible="{Binding SelectedNamespace, Converter={x:Static ObjectConverters.IsNotNull}}"
                  RowDefinitions="Auto,*">
                
                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="{Binding SelectedNamespace.Name}" Classes="title"/>
                        <TextBlock Text="{Binding SelectedNamespace.ResourceGroup}" Classes="caption" Margin="0,4,0,0"/>
                    </StackPanel>
                    <Button Classes="secondary small" Content="Refresh" 
                            Command="{Binding RefreshCommand}"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"/>
                </Grid>
                
                <!-- Main content grid -->
                <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*">
                    <!-- Service Bus Tree View -->
                    <Border Grid.Column="0" Classes="card" Margin="0,0,12,0">
                        <DockPanel>
                            <StackPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                                <TextBlock Text="Entities" Classes="heading"/>
                                <TextBlock Text="Queues, topics and subscriptions" Classes="caption" Margin="0,4,0,0"/>
                            </StackPanel>
                            <ScrollViewer>
                                <StackPanel Spacing="12">
                                    <!-- Queues Section -->
                                    <StackPanel>
                                        <Border Classes="section-header">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                                    <Border Classes="entity-icon-queue">
                                                        <TextBlock Text="ðŸ“¥" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <StackPanel VerticalAlignment="Center">
                                                        <TextBlock Text="Queues" FontWeight="SemiBold" FontSize="14"/>
                                                        <TextBlock Text="Point-to-point messaging" Classes="caption" FontSize="11"/>
                                                    </StackPanel>
                                                </StackPanel>
                                                <Border Grid.Column="2" Classes="badge-muted" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Queues.Count}" FontSize="11" FontWeight="SemiBold" Foreground="#616161"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                        
                                        <ItemsControl ItemsSource="{Binding Queues}" Margin="4,0,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="models:QueueInfo">
                                                    <Button Classes="subtle"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectQueueCommand}"
                                                            CommandParameter="{Binding}"
                                                            HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Stretch"
                                                            Padding="0"
                                                            Margin="0,2">
                                                        <Grid ColumnDefinitions="Auto,*">
                                                            <!-- Selection indicator bar (Fluent 2 accent bar) -->
                                                            <Border Grid.Column="0" Classes="selection-indicator" 
                                                                    VerticalAlignment="Stretch"
                                                                    Margin="0,4,4,4">
                                                                <Border.IsVisible>
                                                                    <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                        <Binding Path="."/>
                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedQueue"/>
                                                                    </MultiBinding>
                                                                </Border.IsVisible>
                                                            </Border>
                                                            
                                                            <!-- Entity content with selection background -->
                                                            <Border Grid.Column="1" Padding="12,10" CornerRadius="6">
                                                                <Border.Background>
                                                                    <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                        <Binding Path="."/>
                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedQueue"/>
                                                                    </MultiBinding>
                                                                </Border.Background>
                                                                <Grid ColumnDefinitions="Auto,*">
                                                                    <Border Grid.Column="0" Classes="entity-icon-queue" Margin="0,0,12,0">
                                                                        <TextBlock Text="Q" FontWeight="Bold" FontSize="14" Foreground="#0F6CBD" 
                                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                    </Border>
                                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13" 
                                                                                   TextTrimming="CharacterEllipsis"/>
                                                                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0" Spacing="8">
                                                                            <Border Classes="counter-active">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="Active:" FontSize="10" Foreground="#0F6CBD"/>
                                                                                    <TextBlock Text="{Binding ActiveMessageCount}" 
                                                                                               FontSize="10" FontWeight="SemiBold" Foreground="#0F6CBD"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                            <Border Classes="counter-dead" IsVisible="{Binding DeadLetterCount}">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="DLQ:" FontSize="10" Foreground="#C42B1C"/>
                                                                                    <TextBlock Text="{Binding DeadLetterCount}" 
                                                                                               FontSize="10" FontWeight="SemiBold" Foreground="#C42B1C"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                            <Border Classes="counter-scheduled" IsVisible="{Binding ScheduledCount}">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="Scheduled:" FontSize="10" Foreground="#986F0B"/>
                                                                                    <TextBlock Text="{Binding ScheduledCount}" 
                                                                                               FontSize="10" FontWeight="SemiBold" Foreground="#986F0B"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                        </StackPanel>
                                                                    </StackPanel>
                                                                </Grid>
                                                            </Border>
                                                        </Grid>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                    
                                    <Border Classes="section-divider"/>
                                    
                                    <!-- Topics Section -->
                                    <StackPanel>
                                        <Border Classes="section-header">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                                    <Border Classes="entity-icon-topic">
                                                        <TextBlock Text="ðŸ“¤" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <StackPanel VerticalAlignment="Center">
                                                        <TextBlock Text="Topics" FontWeight="SemiBold" FontSize="14"/>
                                                        <TextBlock Text="Publish-subscribe messaging" Classes="caption" FontSize="11"/>
                                                    </StackPanel>
                                                </StackPanel>
                                                <Border Grid.Column="2" Classes="badge-muted" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Topics.Count}" FontSize="11" FontWeight="SemiBold" Foreground="#616161"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                        
                                        <ItemsControl ItemsSource="{Binding Topics}" Margin="4,0,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="models:TopicInfo">
                                                    <Expander Margin="0,2" IsExpanded="False">
                                                        <Expander.Header>
                                                            <Button Classes="subtle"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectTopicCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    HorizontalAlignment="Stretch"
                                                                    HorizontalContentAlignment="Stretch"
                                                                    Padding="0">
                                                                <Grid ColumnDefinitions="Auto,*">
                                                                    <!-- Selection indicator bar -->
                                                                    <Border Grid.Column="0" Classes="selection-indicator" 
                                                                            VerticalAlignment="Stretch"
                                                                            Margin="0,4,4,4">
                                                                        <Border.IsVisible>
                                                                            <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                                <Binding Path="."/>
                                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedTopic"/>
                                                                            </MultiBinding>
                                                                        </Border.IsVisible>
                                                                    </Border>
                                                                    
                                                                    <!-- Topic content with selection background -->
                                                                    <Border Grid.Column="1" Padding="8,8" CornerRadius="6">
                                                                        <Border.Background>
                                                                            <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                                <Binding Path="."/>
                                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedTopic"/>
                                                                            </MultiBinding>
                                                                        </Border.Background>
                                                                        <Grid ColumnDefinitions="Auto,*">
                                                                            <Border Grid.Column="0" Classes="entity-icon-topic" Margin="0,0,12,0">
                                                                                <TextBlock Text="T" FontWeight="Bold" FontSize="14" Foreground="#0E7A0D" 
                                                                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                            </Border>
                                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"
                                                                                           TextTrimming="CharacterEllipsis"/>
                                                                                <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Spacing="8">
                                                                                    <Border Classes="badge-muted">
                                                                                        <TextBlock Text="{Binding SubscriptionCount, StringFormat='{}{0} subscriptions'}" 
                                                                                                   FontSize="10" Foreground="#616161"/>
                                                                                    </Border>
                                                                                </StackPanel>
                                                                            </StackPanel>
                                                                        </Grid>
                                                                    </Border>
                                                                </Grid>
                                                            </Button>
                                                        </Expander.Header>
                                                        <!-- Topic Subscriptions -->
                                                        <ItemsControl ItemsSource="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).TopicSubscriptions}"
                                                                      Margin="20,8,0,4"
                                                                      IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectedTopic, Converter={x:Static ObjectConverters.IsNotNull}}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate x:DataType="models:SubscriptionInfo">
                                                                    <Button Classes="subtle"
                                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectSubscriptionCommand}"
                                                                            CommandParameter="{Binding}"
                                                                            HorizontalAlignment="Stretch"
                                                                            HorizontalContentAlignment="Stretch"
                                                                            Padding="0"
                                                                            Margin="0,2">
                                                                        <Grid ColumnDefinitions="Auto,*">
                                                                            <!-- Selection indicator bar -->
                                                                            <Border Grid.Column="0" Classes="selection-indicator" 
                                                                                    VerticalAlignment="Stretch"
                                                                                    Margin="0,4,4,4">
                                                                                <Border.IsVisible>
                                                                                    <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                                        <Binding Path="."/>
                                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedSubscription"/>
                                                                                    </MultiBinding>
                                                                                </Border.IsVisible>
                                                                            </Border>
                                                                            
                                                                            <!-- Subscription content with selection background -->
                                                                            <Border Grid.Column="1" CornerRadius="6" Padding="10,8" BorderBrush="#E8E8E8" BorderThickness="1">
                                                                                <Border.Background>
                                                                                    <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                                        <Binding Path="."/>
                                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedSubscription"/>
                                                                                    </MultiBinding>
                                                                                </Border.Background>
                                                                                <Grid ColumnDefinitions="Auto,*">
                                                                                    <Border Grid.Column="0" Classes="entity-icon-subscription" Width="28" Height="28" Margin="0,0,10,0">
                                                                                        <TextBlock Text="S" FontWeight="Bold" FontSize="12" Foreground="#986F0B" 
                                                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                                    </Border>
                                                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="12"
                                                                                                   TextTrimming="CharacterEllipsis"/>
                                                                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Spacing="6">
                                                                                            <Border Classes="counter-active" Padding="4,2">
                                                                                                <StackPanel Orientation="Horizontal" Spacing="3">
                                                                                                    <TextBlock Text="{Binding ActiveMessageCount}" 
                                                                                                               FontSize="9" FontWeight="SemiBold" Foreground="#0F6CBD"/>
                                                                                                    <TextBlock Text="active" FontSize="9" Foreground="#0F6CBD"/>
                                                                                                </StackPanel>
                                                                                            </Border>
                                                                                            <Border Classes="counter-dead" Padding="4,2" IsVisible="{Binding DeadLetterCount}">
                                                                                                <StackPanel Orientation="Horizontal" Spacing="3">
                                                                                                    <TextBlock Text="{Binding DeadLetterCount}" 
                                                                                                               FontSize="9" FontWeight="SemiBold" Foreground="#C42B1C"/>
                                                                                                    <TextBlock Text="dead" FontSize="9" Foreground="#C42B1C"/>
                                                                                                </StackPanel>
                                                                                            </Border>
                                                                                        </StackPanel>
                                                                                    </StackPanel>
                                                                                </Grid>
                                                                            </Border>
                                                                        </Grid>
                                                                    </Button>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </Expander>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>
                    
                    <!-- Messages Panel -->
                    <Border Grid.Column="1" Classes="card" Margin="12,0,0,0" Padding="0">
                        <Grid RowDefinitions="Auto,*">
                            <!-- Header Bar with Tabs and Actions -->
                            <Border Grid.Row="0" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="16,16,16,12">
                                <Grid RowDefinitions="Auto">
                                    <!-- Title and Actions Row -->
                                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                                            <TextBlock Text="Messages" Classes="heading" VerticalAlignment="Center"/>
                                            <!-- Send Message Button (compact, inline) -->
                                            <Button Classes="primary small" 
                                                    Content="+ Send"
                                                    Command="{Binding OpenSendMessagePopupCommand}"
                                                    Padding="12,6"
                                                    VerticalAlignment="Center">
                                                <Button.IsVisible>
                                                    <MultiBinding Converter="{x:Static BoolConverters.Or}">
                                                        <Binding Path="SelectedQueue" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                                                        <Binding Path="SelectedTopic" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                                                    </MultiBinding>
                                                </Button.IsVisible>
                                            </Button>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6">
                                            <Button Classes="subtle small" 
                                                    Content="{Binding SortButtonText}"
                                                    Command="{Binding ToggleSortOrderCommand}"
                                                    ToolTip.Tip="Toggle sort order"
                                                    Padding="8,6"/>
                                            <Button Classes="subtle small" 
                                                    Content="â†» Peek" 
                                                    Command="{Binding LoadMessagesCommand}"
                                                    Padding="8,6"/>
                                            <Border Width="1" Background="#E0E0E0" Margin="4,4"/>
                                            <Button Classes="danger-subtle small" 
                                                    Content="Purge" 
                                                    Command="{Binding PurgeMessagesCommand}"
                                                    Padding="8,6"/>
                                        </StackPanel>
                                    </Grid>
                                </Grid>
                            </Border>
                            
                            <!-- Tab Content Area -->
                            <TabControl Grid.Row="1" 
                                        x:Name="MessagesTabControl"
                                        SelectedIndex="{Binding SelectedMessageTabIndex}">
                                
                                <TabItem Header="Active Messages">
                                    <ScrollViewer Padding="8">
                                        <ListBox ItemsSource="{Binding Messages}"
                                                 SelectedItem="{Binding SelectedMessage}"
                                                 Background="Transparent">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate x:DataType="models:MessageInfo">
                                                    <Button Classes="subtle"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectMessageCommand}"
                                                            CommandParameter="{Binding}"
                                                            HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Left"
                                                            Padding="12,10"
                                                            Margin="0,2">
                                                        <StackPanel>
                                                            <Grid ColumnDefinitions="*,Auto">
                                                                <TextBlock Grid.Column="0" 
                                                                           Text="{Binding MessageId}" 
                                                                           FontWeight="SemiBold" 
                                                                           FontSize="12"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                                <TextBlock Grid.Column="1"
                                                                           Text="{Binding EnqueuedTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                                                                           Classes="caption" 
                                                                           FontSize="10"
                                                                           Foreground="#707070"/>
                                                            </Grid>
                                                            <TextBlock Text="{Binding Body}" 
                                                                       TextTrimming="CharacterEllipsis"
                                                                       MaxLines="2"
                                                                       Classes="caption" 
                                                                       FontSize="11"
                                                                       Margin="0,6,0,0"
                                                                       Foreground="#505050"/>
                                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" Spacing="6">
                                                                <Border Classes="badge-muted" Padding="6,3">
                                                                    <TextBlock Text="{Binding SequenceNumber, StringFormat='Seq: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                                <Border Classes="badge-muted" Padding="6,3" IsVisible="{Binding DeliveryCount}">
                                                                    <TextBlock Text="{Binding DeliveryCount, StringFormat='Delivery: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Button>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </ScrollViewer>
                                </TabItem>
                                
                                <TabItem Header="Dead Letter">
                                    <ScrollViewer Padding="8">
                                        <ListBox ItemsSource="{Binding Messages}"
                                                 SelectedItem="{Binding SelectedMessage}"
                                                 Background="Transparent">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate x:DataType="models:MessageInfo">
                                                    <Button Classes="subtle"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectMessageCommand}"
                                                            CommandParameter="{Binding}"
                                                            HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Left"
                                                            Padding="12,10"
                                                            Margin="0,2">
                                                        <StackPanel>
                                                            <Grid ColumnDefinitions="*,Auto">
                                                                <TextBlock Grid.Column="0" 
                                                                           Text="{Binding MessageId}" 
                                                                           FontWeight="SemiBold" 
                                                                           FontSize="12"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                                <TextBlock Grid.Column="1"
                                                                           Text="{Binding EnqueuedTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                                                                           Classes="caption" 
                                                                           FontSize="10"
                                                                           Foreground="#707070"/>
                                                            </Grid>
                                                            <!-- Dead Letter Reason -->
                                                            <Border Background="#FDE7E9" Padding="8,4" Margin="0,6,0,0" CornerRadius="4"
                                                                    IsVisible="{Binding DeadLetterReason, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                                <TextBlock Text="{Binding DeadLetterReason}" 
                                                                           Foreground="#C42B1C" 
                                                                           FontSize="11"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                            </Border>
                                                            <TextBlock Text="{Binding Body}" 
                                                                       TextTrimming="CharacterEllipsis"
                                                                       MaxLines="2"
                                                                       Classes="caption" 
                                                                       FontSize="11"
                                                                       Margin="0,6,0,0"
                                                                       Foreground="#505050"/>
                                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" Spacing="6">
                                                                <Border Classes="badge-muted" Padding="6,3">
                                                                    <TextBlock Text="{Binding SequenceNumber, StringFormat='Seq: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                                <Border Classes="badge-muted" Padding="6,3" IsVisible="{Binding DeliveryCount}">
                                                                    <TextBlock Text="{Binding DeliveryCount, StringFormat='Delivery: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Button>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </ScrollViewer>
                                </TabItem>
                            </TabControl>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
            
            <!-- Content when connected via connection string -->
            <Grid Grid.Row="0" Grid.RowSpan="2" 
                  IsVisible="{Binding ActiveConnection, Converter={x:Static ObjectConverters.IsNotNull}}"
                  RowDefinitions="Auto,*">
                
                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="{Binding ActiveConnection.Name}" Classes="title"/>
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,6,0,0">
                            <Border Classes="badge-info" Padding="8,4">
                                <TextBlock Text="{Binding ActiveConnection.TypeDisplayName}" FontSize="12" Foreground="#0F6CBD"/>
                            </Border>
                            <TextBlock Text="{Binding ActiveConnection.EntityName}" Classes="caption" VerticalAlignment="Center"
                                       IsVisible="{Binding ActiveConnection.EntityName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <TextBlock Text="{Binding ActiveConnection.Endpoint}" Classes="caption" VerticalAlignment="Center"
                                       IsVisible="{Binding ActiveConnection.IsNamespaceLevel}"/>
                        </StackPanel>
                    </StackPanel>
                    <Button Classes="secondary small" Content="Refresh" 
                            Command="{Binding RefreshConnectionCommand}"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"/>
                </Grid>
                
                <!-- Main content for connection string mode -->
                <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*">
                    <!-- Entity Tree for connection string mode -->
                    <Border Grid.Column="0" Classes="card" Margin="0,0,12,0">
                        <DockPanel>
                            <StackPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                                <TextBlock Text="Entities" Classes="heading"/>
                                <TextBlock Text="Queues, topics and subscriptions" Classes="caption" Margin="0,4,0,0"/>
                            </StackPanel>
                            <ScrollViewer>
                                <StackPanel Spacing="12">
                                    <!-- Queues Section -->
                                    <StackPanel IsVisible="{Binding HasQueues}">
                                        <Border Classes="section-header">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                                    <Border Classes="entity-icon-queue">
                                                        <TextBlock Text="ðŸ“¥" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <StackPanel VerticalAlignment="Center">
                                                        <TextBlock Text="Queues" FontWeight="SemiBold" FontSize="14"/>
                                                        <TextBlock Text="Point-to-point messaging" Classes="caption" FontSize="11"/>
                                                    </StackPanel>
                                                </StackPanel>
                                                <Border Grid.Column="2" Classes="badge-muted" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Queues.Count}" FontSize="11" FontWeight="SemiBold" Foreground="#616161"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                        
                                        <ItemsControl ItemsSource="{Binding Queues}" Margin="4,0,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="models:QueueInfo">
                                                    <Button Classes="subtle"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectQueueForConnectionCommand}"
                                                            CommandParameter="{Binding}"
                                                            HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Stretch"
                                                            Padding="0"
                                                            Margin="0,2">
                                                        <Grid ColumnDefinitions="Auto,*">
                                                            <!-- Selection indicator bar -->
                                                            <Border Grid.Column="0" Classes="selection-indicator" 
                                                                    VerticalAlignment="Stretch"
                                                                    Margin="0,4,4,4">
                                                                <Border.IsVisible>
                                                                    <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                        <Binding Path="."/>
                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedQueue"/>
                                                                    </MultiBinding>
                                                                </Border.IsVisible>
                                                            </Border>
                                                            
                                                            <!-- Entity content with selection background -->
                                                            <Border Grid.Column="1" Padding="12,10" CornerRadius="6">
                                                                <Border.Background>
                                                                    <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                        <Binding Path="."/>
                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedQueue"/>
                                                                    </MultiBinding>
                                                                </Border.Background>
                                                                <Grid ColumnDefinitions="Auto,*">
                                                                    <Border Grid.Column="0" Classes="entity-icon-queue" Margin="0,0,12,0">
                                                                        <TextBlock Text="Q" FontWeight="Bold" FontSize="14" Foreground="#0F6CBD" 
                                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                    </Border>
                                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13" 
                                                                                   TextTrimming="CharacterEllipsis"/>
                                                                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0" Spacing="8">
                                                                            <Border Classes="counter-active">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="Active:" FontSize="10" Foreground="#0F6CBD"/>
                                                                                    <TextBlock Text="{Binding ActiveMessageCount}" 
                                                                                               FontSize="10" FontWeight="SemiBold" Foreground="#0F6CBD"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                            <Border Classes="counter-dead" IsVisible="{Binding DeadLetterCount}">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="DLQ:" FontSize="10" Foreground="#C42B1C"/>
                                                                                    <TextBlock Text="{Binding DeadLetterCount}" 
                                                                                               FontSize="10" FontWeight="SemiBold" Foreground="#C42B1C"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                            <Border Classes="counter-scheduled" IsVisible="{Binding ScheduledCount}">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="Scheduled:" FontSize="10" Foreground="#986F0B"/>
                                                                                    <TextBlock Text="{Binding ScheduledCount}" 
                                                                                               FontSize="10" FontWeight="SemiBold" Foreground="#986F0B"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                        </StackPanel>
                                                                    </StackPanel>
                                                                </Grid>
                                                            </Border>
                                                        </Grid>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                    
                                    <Border Classes="section-divider" IsVisible="{Binding HasQueues}"/>
                                    
                                    <!-- Topics Section -->
                                    <StackPanel IsVisible="{Binding HasTopics}">
                                        <Border Classes="section-header">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                                    <Border Classes="entity-icon-topic">
                                                        <TextBlock Text="ðŸ“¤" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <StackPanel VerticalAlignment="Center">
                                                        <TextBlock Text="Topics" FontWeight="SemiBold" FontSize="14"/>
                                                        <TextBlock Text="Publish-subscribe messaging" Classes="caption" FontSize="11"/>
                                                    </StackPanel>
                                                </StackPanel>
                                                <Border Grid.Column="2" Classes="badge-muted" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Topics.Count}" FontSize="11" FontWeight="SemiBold" Foreground="#616161"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                        
                                        <ItemsControl ItemsSource="{Binding Topics}" Margin="4,0,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="models:TopicInfo">
                                                    <Expander Margin="0,2" IsExpanded="False">
                                                        <Expander.Header>
                                                            <Button Classes="subtle"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectTopicForConnectionCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    HorizontalAlignment="Stretch"
                                                                    HorizontalContentAlignment="Stretch"
                                                                    Padding="0">
                                                                <Grid ColumnDefinitions="Auto,*">
                                                                    <!-- Selection indicator bar -->
                                                                    <Border Grid.Column="0" Classes="selection-indicator" 
                                                                            VerticalAlignment="Stretch"
                                                                            Margin="0,4,4,4">
                                                                        <Border.IsVisible>
                                                                            <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                                <Binding Path="."/>
                                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedTopic"/>
                                                                            </MultiBinding>
                                                                        </Border.IsVisible>
                                                                    </Border>
                                                                    
                                                                    <!-- Topic content with selection background -->
                                                                    <Border Grid.Column="1" Padding="8,8" CornerRadius="6">
                                                                        <Border.Background>
                                                                            <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                                <Binding Path="."/>
                                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedTopic"/>
                                                                            </MultiBinding>
                                                                        </Border.Background>
                                                                        <Grid ColumnDefinitions="Auto,*">
                                                                            <Border Grid.Column="0" Classes="entity-icon-topic" Margin="0,0,12,0">
                                                                                <TextBlock Text="T" FontWeight="Bold" FontSize="14" Foreground="#0E7A0D" 
                                                                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                            </Border>
                                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"
                                                                                           TextTrimming="CharacterEllipsis"/>
                                                                                <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Spacing="8">
                                                                                    <Border Classes="badge-muted">
                                                                                        <TextBlock Text="{Binding SubscriptionCount, StringFormat='{}{0} subscriptions'}" 
                                                                                                   FontSize="10" Foreground="#616161"/>
                                                                                    </Border>
                                                                                </StackPanel>
                                                                            </StackPanel>
                                                                        </Grid>
                                                                    </Border>
                                                                </Grid>
                                                            </Button>
                                                        </Expander.Header>
                                                        <!-- Topic Subscriptions -->
                                                        <ItemsControl ItemsSource="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).TopicSubscriptions}"
                                                                      Margin="20,8,0,4"
                                                                      IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectedTopic, Converter={x:Static ObjectConverters.IsNotNull}}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate x:DataType="models:SubscriptionInfo">
                                                                    <Button Classes="subtle"
                                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectSubscriptionForConnectionCommand}"
                                                                            CommandParameter="{Binding}"
                                                                            HorizontalAlignment="Stretch"
                                                                            HorizontalContentAlignment="Stretch"
                                                                            Padding="0"
                                                                            Margin="0,2">
                                                                        <Grid ColumnDefinitions="Auto,*">
                                                                            <!-- Selection indicator bar -->
                                                                            <Border Grid.Column="0" Classes="selection-indicator" 
                                                                                    VerticalAlignment="Stretch"
                                                                                    Margin="0,4,4,4">
                                                                                <Border.IsVisible>
                                                                                    <MultiBinding Converter="{StaticResource EntitySelectionConverter}">
                                                                                        <Binding Path="."/>
                                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedSubscription"/>
                                                                                    </MultiBinding>
                                                                                </Border.IsVisible>
                                                                            </Border>
                                                                            
                                                                            <!-- Subscription content with selection background -->
                                                                            <Border Grid.Column="1" CornerRadius="6" Padding="10,8" BorderBrush="#E8E8E8" BorderThickness="1">
                                                                                <Border.Background>
                                                                                    <MultiBinding Converter="{StaticResource EntitySelectionBackgroundConverter}">
                                                                                        <Binding Path="."/>
                                                                                        <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedSubscription"/>
                                                                                    </MultiBinding>
                                                                                </Border.Background>
                                                                                <Grid ColumnDefinitions="Auto,*">
                                                                                    <Border Grid.Column="0" Classes="entity-icon-subscription" Width="28" Height="28" Margin="0,0,10,0">
                                                                                        <TextBlock Text="S" FontWeight="Bold" FontSize="12" Foreground="#986F0B" 
                                                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                                    </Border>
                                                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="12"
                                                                                                   TextTrimming="CharacterEllipsis"/>
                                                                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Spacing="6">
                                                                                            <Border Classes="counter-active" Padding="4,2">
                                                                                                <StackPanel Orientation="Horizontal" Spacing="3">
                                                                                                    <TextBlock Text="{Binding ActiveMessageCount}" 
                                                                                                               FontSize="9" FontWeight="SemiBold" Foreground="#0F6CBD"/>
                                                                                                    <TextBlock Text="active" FontSize="9" Foreground="#0F6CBD"/>
                                                                                                </StackPanel>
                                                                                            </Border>
                                                                                            <Border Classes="counter-dead" Padding="4,2" IsVisible="{Binding DeadLetterCount}">
                                                                                                <StackPanel Orientation="Horizontal" Spacing="3">
                                                                                                    <TextBlock Text="{Binding DeadLetterCount}" 
                                                                                                               FontSize="9" FontWeight="SemiBold" Foreground="#C42B1C"/>
                                                                                                    <TextBlock Text="dead" FontSize="9" Foreground="#C42B1C"/>
                                                                                                </StackPanel>
                                                                                            </Border>
                                                                                        </StackPanel>
                                                                                    </StackPanel>
                                                                                </Grid>
                                                                            </Border>
                                                                        </Grid>
                                                                    </Button>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </Expander>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>
                    
                    <!-- Messages Panel (reusing same structure as Azure mode) -->
                    <Border Grid.Column="1" Classes="card" Margin="12,0,0,0" Padding="0">
                        <Grid RowDefinitions="Auto,*">
                            <!-- Header Bar with Tabs and Actions -->
                            <Border Grid.Row="0" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="16,16,16,12">
                                <Grid RowDefinitions="Auto">
                                    <!-- Title and Actions Row -->
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                                            <TextBlock Text="Messages" Classes="heading" VerticalAlignment="Center"/>
                                            <!-- Send Message Button (compact, inline) -->
                                            <Button Classes="primary small" 
                                                    Content="+ Send"
                                                    Command="{Binding OpenSendMessagePopupCommand}"
                                                    Padding="12,6"
                                                    VerticalAlignment="Center">
                                                <Button.IsVisible>
                                                    <MultiBinding Converter="{x:Static BoolConverters.Or}">
                                                        <Binding Path="SelectedQueue" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                                                        <Binding Path="SelectedTopic" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                                                    </MultiBinding>
                                                </Button.IsVisible>
                                            </Button>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6">
                                            <Button Classes="subtle small" 
                                                    Content="{Binding SortButtonText}"
                                                    Command="{Binding ToggleSortOrderCommand}"
                                                    ToolTip.Tip="Toggle sort order"
                                                    Padding="8,6"/>
                                            <Button Classes="subtle small" 
                                                    Content="â†» Refresh" 
                                                    Command="{Binding LoadMessagesCommand}"
                                                    Padding="8,6"/>
                                            <Border Width="1" Background="#E0E0E0" Margin="4,4"/>
                                            <Button Classes="danger-subtle small" 
                                                    Content="Purge" 
                                                    Command="{Binding PurgeMessagesCommand}"
                                                    Padding="8,6"/>
                                        </StackPanel>
                                    </Grid>
                                </Grid>
                            </Border>
                            
                            <!-- Tab Content Area -->
                            <TabControl Grid.Row="1" 
                                        SelectedIndex="{Binding SelectedMessageTabIndex}">
                                
                                <TabItem Header="Active Messages">
                                    <ScrollViewer Padding="8">
                                        <ListBox ItemsSource="{Binding Messages}"
                                                 SelectedItem="{Binding SelectedMessage}"
                                                 Background="Transparent">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate x:DataType="models:MessageInfo">
                                                    <Button Classes="subtle"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectMessageCommand}"
                                                            CommandParameter="{Binding}"
                                                            HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Left"
                                                            Padding="12,10"
                                                            Margin="0,2">
                                                        <StackPanel>
                                                            <Grid ColumnDefinitions="*,Auto">
                                                                <TextBlock Grid.Column="0" 
                                                                           Text="{Binding MessageId}" 
                                                                           FontWeight="SemiBold" 
                                                                           FontSize="12"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                                <TextBlock Grid.Column="1" 
                                                                           Text="{Binding EnqueuedTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                                                                           Classes="caption" 
                                                                           FontSize="10"
                                                                           Foreground="#707070"/>
                                                            </Grid>
                                                            <TextBlock Text="{Binding Body}" 
                                                                       Classes="caption" 
                                                                       FontSize="11"
                                                                       TextTrimming="CharacterEllipsis"
                                                                       MaxLines="2"
                                                                       Margin="0,6,0,0"
                                                                       Foreground="#505050"/>
                                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" Spacing="6">
                                                                <Border Classes="badge-muted" Padding="6,3">
                                                                    <TextBlock Text="{Binding SequenceNumber, StringFormat='Seq: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                                <Border Classes="badge-muted" Padding="6,3" IsVisible="{Binding DeliveryCount}">
                                                                    <TextBlock Text="{Binding DeliveryCount, StringFormat='Delivery: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Button>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </ScrollViewer>
                                </TabItem>
                                
                                <TabItem Header="Dead Letter">
                                    <ScrollViewer Padding="8">
                                        <ListBox ItemsSource="{Binding Messages}"
                                                 SelectedItem="{Binding SelectedMessage}"
                                                 Background="Transparent">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate x:DataType="models:MessageInfo">
                                                    <Button Classes="subtle"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectMessageCommand}"
                                                            CommandParameter="{Binding}"
                                                            HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Left"
                                                            Padding="12,10"
                                                            Margin="0,2">
                                                        <StackPanel>
                                                            <Grid ColumnDefinitions="*,Auto">
                                                                <TextBlock Grid.Column="0" 
                                                                           Text="{Binding MessageId}" 
                                                                           FontWeight="SemiBold" 
                                                                           FontSize="12"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                                <TextBlock Grid.Column="1" 
                                                                           Text="{Binding EnqueuedTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                                                                           Classes="caption" 
                                                                           FontSize="10"
                                                                           Foreground="#707070"/>
                                                            </Grid>
                                                            <!-- Dead Letter Reason -->
                                                            <Border Background="#FDE7E9" Padding="8,4" Margin="0,6,0,0" CornerRadius="4"
                                                                    IsVisible="{Binding DeadLetterReason, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                                <TextBlock Text="{Binding DeadLetterReason}" 
                                                                           Foreground="#C42B1C" 
                                                                           FontSize="11"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                            </Border>
                                                            <TextBlock Text="{Binding Body}" 
                                                                       Classes="caption" 
                                                                       FontSize="11"
                                                                       TextTrimming="CharacterEllipsis"
                                                                       MaxLines="2"
                                                                       Margin="0,6,0,0"
                                                                       Foreground="#505050"/>
                                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" Spacing="6">
                                                                <Border Classes="badge-muted" Padding="6,3">
                                                                    <TextBlock Text="{Binding SequenceNumber, StringFormat='Seq: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                                <Border Classes="badge-muted" Padding="6,3" IsVisible="{Binding DeliveryCount}">
                                                                    <TextBlock Text="{Binding DeliveryCount, StringFormat='Delivery: {0}'}" 
                                                                               Foreground="#616161" FontSize="10"/>
                                                                </Border>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Button>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </ScrollViewer>
                                </TabItem>
                            </TabControl>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
            
            <!-- Status Bar -->
            <Border Grid.Row="2" Margin="0,12,0,0">
                <Grid ColumnDefinitions="Auto,*">
                    <ProgressBar Grid.Column="0" 
                                 IsIndeterminate="True" 
                                 IsVisible="{Binding IsLoading}"
                                 Width="100" Height="3"/>
                    <Button Grid.Column="1" 
                            Classes="subtle"
                            Command="{Binding ToggleStatusPopupCommand}"
                            HorizontalAlignment="Left"
                            Margin="12,0"
                            Padding="8,4"
                            Cursor="Hand"
                            ToolTip.Tip="Click to see full message">
                        <TextBlock Text="{Binding StatusMessage}" 
                                   Classes="caption"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="400"/>
                    </Button>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Status Message Popup -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding ShowStatusPopup}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="400"
                    MaxWidth="600">
                <DockPanel>
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,16">
                        <TextBlock Text="Status Message" Classes="heading"/>
                        <Button Classes="icon" 
                                Content="Ã—" 
                                FontSize="18"
                                HorizontalAlignment="Right"
                                Command="{Binding CloseStatusPopupCommand}"/>
                    </Grid>
                    <Border Classes="surface-subtle" Padding="12">
                        <SelectableTextBlock Text="{Binding StatusMessage}" 
                                             TextWrapping="Wrap" 
                                             FontFamily="Cascadia Code, Consolas, Monaco, monospace"
                                             FontSize="12"/>
                    </Border>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Message Detail Modal -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding SelectedMessage, Converter={x:Static ObjectConverters.IsNotNull}}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="600"
                    MaxWidth="800"
                    MaxHeight="700">
                <DockPanel>
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,16">
                        <TextBlock Text="Message Details" Classes="heading"/>
                        <Button Classes="icon" 
                                Content="Ã—" 
                                FontSize="18"
                                HorizontalAlignment="Right"
                                Command="{Binding ClearSelectedMessageCommand}"/>
                    </Grid>
                    <ScrollViewer>
                        <StackPanel Spacing="12">
                            <!-- Dead Letter Info Section (only visible for dead letter messages) -->
                            <Border Classes="surface-danger" Padding="12" Margin="0,0,0,8"
                                    IsVisible="{Binding SelectedMessage.DeadLetterReason, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Dead Letter Information" FontWeight="Bold" Foreground="#C42B1C"/>
                                    <StackPanel IsVisible="{Binding SelectedMessage.DeadLetterReason, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <TextBlock Text="Reason" Classes="caption" Foreground="#C42B1C" Margin="0,0,0,2"/>
                                        <SelectableTextBlock Text="{Binding SelectedMessage.DeadLetterReason}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    <StackPanel IsVisible="{Binding SelectedMessage.DeadLetterErrorDescription, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <TextBlock Text="Error Description" Classes="caption" Foreground="#C42B1C" Margin="0,0,0,2"/>
                                        <SelectableTextBlock Text="{Binding SelectedMessage.DeadLetterErrorDescription}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    <StackPanel IsVisible="{Binding SelectedMessage.DeadLetterSource, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <TextBlock Text="Source" Classes="caption" Foreground="#C42B1C" Margin="0,0,0,2"/>
                                        <SelectableTextBlock Text="{Binding SelectedMessage.DeadLetterSource}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                            
                            <!-- Basic Message Properties -->
                            <TextBlock Text="Message Properties" Classes="body-strong" Margin="0,0,0,4"/>
                            
                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto">
                                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,8">
                                    <TextBlock Text="Message ID" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.MessageId}" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                </StackPanel>
                                <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,0,8">
                                    <TextBlock Text="Correlation ID" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.CorrelationId}" TextWrapping="Wrap"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,8,8">
                                    <TextBlock Text="Sequence Number" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.SequenceNumber}"/>
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,0,0,8">
                                    <TextBlock Text="Delivery Count" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.DeliveryCount}"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,8,8">
                                    <TextBlock Text="Enqueued Time" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.EnqueuedTime}"/>
                                </StackPanel>
                                <StackPanel Grid.Row="2" Grid.Column="1" Margin="8,0,0,8">
                                    <TextBlock Text="Expires At" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.ExpiresAt}"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="3" Grid.Column="0" Margin="0,0,8,8"
                                            IsVisible="{Binding SelectedMessage.ScheduledEnqueueTime, Converter={x:Static ObjectConverters.IsNotNull}}">
                                    <TextBlock Text="Scheduled Enqueue Time" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.ScheduledEnqueueTime}"/>
                                </StackPanel>
                                <StackPanel Grid.Row="3" Grid.Column="1" Margin="8,0,0,8">
                                    <TextBlock Text="Time to Live" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.TimeToLive}"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="4" Grid.Column="0" Margin="0,0,8,8">
                                    <TextBlock Text="Content Type" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.ContentType}"/>
                                </StackPanel>
                                <StackPanel Grid.Row="4" Grid.Column="1" Margin="8,0,0,8"
                                            IsVisible="{Binding SelectedMessage.SessionId, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                    <TextBlock Text="Session ID" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.SessionId}" TextWrapping="Wrap"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="5" Grid.Column="0" Margin="0,0,8,8"
                                            IsVisible="{Binding SelectedMessage.Subject, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                    <TextBlock Text="Subject" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.Subject}" TextWrapping="Wrap"/>
                                </StackPanel>
                                <StackPanel Grid.Row="5" Grid.Column="1" Margin="8,0,0,8"
                                            IsVisible="{Binding SelectedMessage.PartitionKey, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                    <TextBlock Text="Partition Key" Classes="caption" Margin="0,0,0,2"/>
                                    <SelectableTextBlock Text="{Binding SelectedMessage.PartitionKey}" TextWrapping="Wrap"/>
                                </StackPanel>
                            </Grid>
                            
                            <!-- Routing Properties -->
                            <StackPanel Spacing="8"
                                        IsVisible="{Binding SelectedMessage.To, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <TextBlock Text="Routing Properties" Classes="body-strong" Margin="0,8,0,4"/>
                                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto">
                                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,8"
                                                IsVisible="{Binding SelectedMessage.To, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <TextBlock Text="To" Classes="caption" Margin="0,0,0,2"/>
                                        <SelectableTextBlock Text="{Binding SelectedMessage.To}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,0,8"
                                                IsVisible="{Binding SelectedMessage.ReplyTo, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <TextBlock Text="Reply To" Classes="caption" Margin="0,0,0,2"/>
                                        <SelectableTextBlock Text="{Binding SelectedMessage.ReplyTo}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,0,0,8"
                                                IsVisible="{Binding SelectedMessage.ReplyToSessionId, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <TextBlock Text="Reply To Session ID" Classes="caption" Margin="0,0,0,2"/>
                                        <SelectableTextBlock Text="{Binding SelectedMessage.ReplyToSessionId}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                            
                            <!-- Application Properties -->
                            <StackPanel Spacing="8"
                                        IsVisible="{Binding FormattedApplicationProperties, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <TextBlock Text="Application Properties" Classes="body-strong" Margin="0,8,0,4"/>
                                <Border Classes="surface-subtle" Padding="12">
                                    <SelectableTextBlock Text="{Binding FormattedApplicationProperties}" 
                                                         TextWrapping="Wrap" 
                                                         FontFamily="Cascadia Code, Consolas, Monaco, monospace"
                                                         FontSize="12"/>
                                </Border>
                            </StackPanel>
                            
                            <!-- Message Body (at the end) -->
                            <StackPanel Margin="0,8,0,0">
                                <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,4">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="Body" Classes="body-strong"/>
                                        <Border Classes="badge" IsVisible="{Binding IsMessageBodyJson}">
                                            <TextBlock Text="JSON" Foreground="White" FontSize="10" FontWeight="SemiBold"/>
                                        </Border>
                                    </StackPanel>
                                    <Button Grid.Column="1" 
                                            Classes="subtle small"
                                            Content="Copy"
                                            Command="{Binding CopyMessageBodyCommand}"
                                            ToolTip.Tip="Copy body to clipboard"/>
                                </Grid>
                                <Border Classes="surface-subtle" Padding="12" MaxHeight="300">
                                    <ScrollViewer HorizontalScrollBarVisibility="Auto">
                                        <SelectableTextBlock Text="{Binding FormattedMessageBody}" 
                                                             TextWrapping="Wrap" 
                                                             FontFamily="Cascadia Code, Consolas, Monaco, monospace"
                                                             FontSize="12"/>
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Send Message Popup - Redesigned Fluent 2 -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding ShowSendMessagePopup}">
            <Border Classes="send-message-panel" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    Width="800"
                    MaxHeight="750">
                
                <!-- Header Section -->
                <DockPanel>
                    <Border DockPanel.Dock="Top" 
                            Background="#FAFAFA" 
                            Padding="24,20" 
                            CornerRadius="12,12,0,0"
                            BorderBrush="#E8E8E8"
                            BorderThickness="0,0,0,1">
                        <Grid>
                            <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                                <!-- Icon -->
                                <Border Background="#E6F2FB" 
                                        CornerRadius="8" 
                                        Width="40" Height="40"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="âœ‰" 
                                               FontSize="18" 
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center"
                                               Foreground="#0F6CBD"/>
                                </Border>
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="Send Message" Classes="heading"/>
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="to" Classes="caption"/>
                                        <TextBlock Text="{Binding SendMessageViewModel.EntityName}" 
                                                   Classes="caption"
                                                   FontWeight="SemiBold"
                                                   Foreground="#0F6CBD"/>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Header Actions -->
                            <StackPanel Orientation="Horizontal" 
                                        HorizontalAlignment="Right" 
                                        VerticalAlignment="Center"
                                        Spacing="4">
                                <Button Classes="toolbar" ToolTip.Tip="Load saved template">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="ðŸ“‚" FontSize="14"/>
                                        <TextBlock Text="Load" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <Button.Flyout>
                                        <Flyout Placement="BottomEdgeAlignedRight">
                                            <Border MinWidth="280" MaxHeight="350">
                                                <StackPanel Spacing="8">
                                                    <TextBlock Text="Saved Templates" Classes="body-strong"/>
                                                    <ScrollViewer MaxHeight="280">
                                                        <StackPanel Spacing="4">
                                                            <ItemsControl ItemsSource="{Binding SendMessageViewModel.SavedMessages}">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate x:DataType="models:SavedMessage">
                                                                        <Border Classes="property-row" Padding="10,8">
                                                                            <Grid ColumnDefinitions="*,Auto">
                                                                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"/>
                                                                                    <TextBlock Text="{Binding CreatedAt, StringFormat='{}{0:MMM d, yyyy}'}" 
                                                                                               Classes="caption" FontSize="11"/>
                                                                                </StackPanel>
                                                                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                                                                                    <Button Classes="primary small" 
                                                                                            Content="Use"
                                                                                            Padding="12,4"
                                                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.LoadMessageCommand}"
                                                                                            CommandParameter="{Binding}"/>
                                                                                    <Button Classes="icon" 
                                                                                            Content="ðŸ—‘" FontSize="12"
                                                                                            ToolTip.Tip="Delete template"
                                                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.DeleteSavedMessageCommand}"
                                                                                            CommandParameter="{Binding}"/>
                                                                                </StackPanel>
                                                                            </Grid>
                                                                        </Border>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                            <TextBlock Text="No saved templates yet" 
                                                                       Classes="caption" 
                                                                       HorizontalAlignment="Center"
                                                                       Margin="0,12"
                                                                       IsVisible="{Binding !SendMessageViewModel.SavedMessages.Count}"/>
                                                        </StackPanel>
                                                    </ScrollViewer>
                                                </StackPanel>
                                            </Border>
                                        </Flyout>
                                    </Button.Flyout>
                                </Button>
                                <Button Classes="toolbar" 
                                        ToolTip.Tip="Save as template"
                                        Command="{Binding SendMessageViewModel.ShowSaveCommand}">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="ðŸ’¾" FontSize="14"/>
                                        <TextBlock Text="Save" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Border Width="1" Height="20" Background="#E0E0E0" Margin="8,0"/>
                                <Button Classes="toolbar" 
                                        ToolTip.Tip="Clear all fields"
                                        Command="{Binding SendMessageViewModel.ClearFormCommand}">
                                    <TextBlock Text="ðŸ”„" FontSize="14"/>
                                </Button>
                                <Button Classes="icon" 
                                        Content="Ã—" 
                                        FontSize="20"
                                        FontWeight="Light"
                                        ToolTip.Tip="Close"
                                        Command="{Binding CancelSendMessageCommand}"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                    
                    <!-- Error Message -->
                    <Border DockPanel.Dock="Top" 
                            Classes="infobar-error" 
                            Margin="24,16,24,0"
                            IsVisible="{Binding SendMessageViewModel.ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <Grid ColumnDefinitions="Auto,*">
                            <TextBlock Text="âš " FontSize="16" Margin="0,0,10,0" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                       Text="{Binding SendMessageViewModel.ErrorMessage}" 
                                       Foreground="#C42B1C"
                                       TextWrapping="Wrap"/>
                        </Grid>
                    </Border>
                    
                    <!-- Footer with Buttons -->
                    <Border DockPanel.Dock="Bottom" 
                            Padding="24,16" 
                            Background="#FAFAFA"
                            CornerRadius="0,0,12,12"
                            BorderBrush="#E8E8E8"
                            BorderThickness="0,1,0,0">
                        <Grid>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="ðŸ’¡" FontSize="13" VerticalAlignment="Center"/>
                                <TextBlock Text="Press Ctrl+Enter to send quickly" 
                                           Classes="caption" 
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" 
                                        HorizontalAlignment="Right" 
                                        Spacing="8">
                                <Button Classes="secondary" 
                                        Content="Cancel" 
                                        Padding="20,10"
                                        Command="{Binding CancelSendMessageCommand}"/>
                                <Button Classes="primary" 
                                        Padding="24,10"
                                        Command="{Binding SendMessageViewModel.SendCommand}"
                                        IsEnabled="{Binding !SendMessageViewModel.IsSending}">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="Send Message" VerticalAlignment="Center"/>
                                        <TextBlock Text="â†’" FontSize="14" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Border>
                    
                    <!-- Main Content -->
                    <ScrollViewer Padding="24,20">
                        <StackPanel Spacing="20">
                            
                            <!-- Message Body Section -->
                            <StackPanel Spacing="8">
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="Message Body" Classes="body-strong"/>
                                        <Border Classes="badge-danger" Padding="4,1">
                                            <TextBlock Text="Required" FontSize="9" Foreground="White"/>
                                        </Border>
                                    </StackPanel>
                                    <!-- Format toolbar -->
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="2">
                                        <Button Classes="chip" Content="JSON" Padding="10,4" FontSize="11"/>
                                        <Button Classes="chip" Content="XML" Padding="10,4" FontSize="11"/>
                                        <Button Classes="chip" Content="Plain" Padding="10,4" FontSize="11"/>
                                    </StackPanel>
                                </Grid>
                                <TextBox Text="{Binding SendMessageViewModel.Body}"
                                         Classes="code-editor"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"
                                         Height="160"
                                         Watermark="Enter your message body here...&#x0a;&#x0a;{&#x0a;  &quot;key&quot;: &quot;value&quot;&#x0a;}"/>
                            </StackPanel>
                            
                            <!-- Standard Properties - Collapsed by default with summary -->
                            <Border Classes="surface-subtle" Padding="20" CornerRadius="8">
                                <Expander IsExpanded="True" HorizontalAlignment="Stretch">
                                    <Expander.Header>
                                        <StackPanel Orientation="Horizontal" Spacing="12">
                                            <TextBlock Text="âš™" FontSize="16" VerticalAlignment="Center"/>
                                            <StackPanel>
                                                <TextBlock Text="Message Properties" FontWeight="SemiBold" FontSize="14"/>
                                                <TextBlock Text="Content type, IDs, routing" Classes="caption" FontSize="11"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Expander.Header>
                                    
                                    <StackPanel Margin="0,20,0,0" Spacing="20">
                                        <!-- Essential Properties Group -->
                                        <StackPanel Spacing="12">
                                            <TextBlock Text="ESSENTIAL" Classes="field-group-header"/>
                                            <Grid ColumnDefinitions="*,16,*" RowDefinitions="Auto">
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Content Type" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.ContentType}" 
                                                             Watermark="application/json"/>
                                                    <TextBlock Text="MIME type of the message body" Classes="field-hint"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock Text="Message ID" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.MessageId}" 
                                                             Watermark="Leave empty to auto-generate"/>
                                                    <TextBlock Text="Unique identifier for the message" Classes="field-hint"/>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                        
                                        <!-- Correlation Group -->
                                        <StackPanel Spacing="12">
                                            <TextBlock Text="CORRELATION &amp; SESSIONS" Classes="field-group-header"/>
                                            <Grid ColumnDefinitions="*,16,*" RowDefinitions="Auto,16,Auto">
                                                <StackPanel Grid.Row="0" Grid.Column="0">
                                                    <TextBlock Text="Correlation ID" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.CorrelationId}" 
                                                             Watermark="Optional"/>
                                                </StackPanel>
                                                <StackPanel Grid.Row="0" Grid.Column="2">
                                                    <TextBlock Text="Session ID" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.SessionId}" 
                                                             Watermark="Required for session-enabled entities"/>
                                                </StackPanel>
                                                <StackPanel Grid.Row="2" Grid.Column="0">
                                                    <TextBlock Text="Reply To Session ID" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.ReplyToSessionId}" 
                                                             Watermark="Optional"/>
                                                </StackPanel>
                                                <StackPanel Grid.Row="2" Grid.Column="2">
                                                    <TextBlock Text="Partition Key" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.PartitionKey}" 
                                                             Watermark="Optional"/>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                        
                                        <!-- Routing Group -->
                                        <StackPanel Spacing="12">
                                            <TextBlock Text="ROUTING &amp; ADDRESSING" Classes="field-group-header"/>
                                            <Grid ColumnDefinitions="*,16,*,16,*" RowDefinitions="Auto">
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Subject (Label)" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.Subject}" 
                                                             Watermark="Optional"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock Text="To" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.To}" 
                                                             Watermark="Destination"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="4">
                                                    <TextBlock Text="Reply To" Classes="field-label"/>
                                                    <TextBox Text="{Binding SendMessageViewModel.ReplyTo}" 
                                                             Watermark="Reply address"/>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                    </StackPanel>
                                </Expander>
                            </Border>
                            
                            <!-- Scheduling Section -->
                            <Border Classes="surface-subtle" Padding="20" CornerRadius="8">
                                <Expander HorizontalAlignment="Stretch">
                                    <Expander.Header>
                                        <StackPanel Orientation="Horizontal" Spacing="12">
                                            <TextBlock Text="â±" FontSize="16" VerticalAlignment="Center"/>
                                            <StackPanel>
                                                <TextBlock Text="Scheduling" FontWeight="SemiBold" FontSize="14"/>
                                                <TextBlock Text="TTL and scheduled delivery" Classes="caption" FontSize="11"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Expander.Header>
                                    
                                    <Grid ColumnDefinitions="*,16,*" Margin="0,20,0,0">
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="Time to Live" Classes="field-label"/>
                                            <TextBox Text="{Binding SendMessageViewModel.TimeToLiveText}" 
                                                     Watermark="e.g., 00:30:00 or 1800"/>
                                            <TextBlock Text="Format: HH:MM:SS or seconds" Classes="field-hint"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="Scheduled Enqueue Time" Classes="field-label"/>
                                            <TextBox Text="{Binding SendMessageViewModel.ScheduledEnqueueTimeText}" 
                                                     Watermark="e.g., 2024-12-25T10:00:00Z"/>
                                            <TextBlock Text="ISO 8601 format" Classes="field-hint"/>
                                        </StackPanel>
                                    </Grid>
                                </Expander>
                            </Border>
                            
                            <!-- Custom Properties Section -->
                            <Border Classes="surface-subtle" Padding="20" CornerRadius="8">
                                <Expander HorizontalAlignment="Stretch">
                                    <Expander.Header>
                                        <StackPanel Orientation="Horizontal" Spacing="12">
                                            <TextBlock Text="ðŸ·" FontSize="16" VerticalAlignment="Center"/>
                                            <StackPanel>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <TextBlock Text="Custom Properties" FontWeight="SemiBold" FontSize="14"/>
                                                    <Border Classes="badge-muted" Padding="6,2" 
                                                            IsVisible="{Binding SendMessageViewModel.CustomProperties.Count}">
                                                        <TextBlock Text="{Binding SendMessageViewModel.CustomProperties.Count}" 
                                                                   FontSize="10" Foreground="#424242"/>
                                                    </Border>
                                                </StackPanel>
                                                <TextBlock Text="Add custom key-value pairs" Classes="caption" FontSize="11"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Expander.Header>
                                    
                                    <StackPanel Margin="0,20,0,0" Spacing="8">
                                        <!-- Header row for properties -->
                                        <Grid ColumnDefinitions="*,16,*,40" 
                                              Margin="12,0,12,4"
                                              IsVisible="{Binding SendMessageViewModel.CustomProperties.Count}">
                                            <TextBlock Grid.Column="0" Text="KEY" Classes="field-group-header" Margin="0"/>
                                            <TextBlock Grid.Column="2" Text="VALUE" Classes="field-group-header" Margin="0"/>
                                        </Grid>
                                        
                                        <ItemsControl ItemsSource="{Binding SendMessageViewModel.CustomProperties}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="models:CustomProperty">
                                                    <Border Classes="property-row">
                                                        <Grid ColumnDefinitions="*,16,*,Auto">
                                                            <TextBox Grid.Column="0" 
                                                                     Text="{Binding Key}" 
                                                                     Watermark="Enter key"
                                                                     Padding="10,8"/>
                                                            <TextBox Grid.Column="2" 
                                                                     Text="{Binding Value}" 
                                                                     Watermark="Enter value"
                                                                     Padding="10,8"/>
                                                            <Button Grid.Column="3" 
                                                                    Classes="icon" 
                                                                    Content="âœ•"
                                                                    FontSize="12"
                                                                    Foreground="#8A8A8A"
                                                                    ToolTip.Tip="Remove property"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.RemoveCustomPropertyCommand}"
                                                                    CommandParameter="{Binding}"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        
                                        <Button Classes="secondary small" 
                                                Padding="16,8"
                                                HorizontalAlignment="Left"
                                                Command="{Binding SendMessageViewModel.AddCustomPropertyCommand}">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock Text="+" FontWeight="Bold"/>
                                                <TextBlock Text="Add Property"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Expander>
                            </Border>
                            
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Save Message Dialog - Redesigned -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding SendMessageViewModel.ShowSaveDialog, FallbackValue=False, TargetNullValue=False}">
            <Border Classes="send-message-panel" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    Width="420"
                    Padding="24">
                <StackPanel Spacing="20">
                    <!-- Header with icon -->
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Border Background="#E6F2FB" 
                                CornerRadius="8" 
                                Width="40" Height="40">
                            <TextBlock Text="ðŸ’¾" 
                                       FontSize="18" 
                                       HorizontalAlignment="Center" 
                                       VerticalAlignment="Center"/>
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Save as Template" Classes="heading"/>
                            <TextBlock Text="Reuse this message later" Classes="caption"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Form -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="Template Name" Classes="field-label"/>
                        <TextBox Text="{Binding SendMessageViewModel.SaveMessageName}" 
                                 Watermark="Enter a descriptive name..."
                                 Padding="12,10"/>
                        <TextBlock Text="Choose a name that helps you identify this template" Classes="field-hint"/>
                    </StackPanel>
                    
                    <!-- Actions -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                        <Button Classes="secondary" 
                                Content="Cancel" 
                                Padding="16,10"
                                Command="{Binding SendMessageViewModel.HideSaveCommand}"/>
                        <Button Classes="primary" 
                                Padding="20,10"
                                Command="{Binding SendMessageViewModel.SaveMessageCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Save Template"/>
                                <TextBlock Text="âœ“" FontSize="12"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
        
        <!-- Load Message Dialog - Redesigned -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding SendMessageViewModel.ShowLoadDialog, FallbackValue=False, TargetNullValue=False}">
            <Border Classes="send-message-panel" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    Width="520"
                    MaxHeight="500"
                    Padding="0">
                <DockPanel>
                    <!-- Header -->
                    <Border DockPanel.Dock="Top" 
                            Background="#FAFAFA" 
                            Padding="24,20" 
                            CornerRadius="12,12,0,0"
                            BorderBrush="#E8E8E8"
                            BorderThickness="0,0,0,1">
                        <Grid>
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <Border Background="#E6F2FB" 
                                        CornerRadius="8" 
                                        Width="40" Height="40">
                                    <TextBlock Text="ðŸ“‚" 
                                               FontSize="18" 
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center"/>
                                </Border>
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="Load Template" Classes="heading"/>
                                    <TextBlock Text="Select a saved message template" Classes="caption"/>
                                </StackPanel>
                            </StackPanel>
                            <Button Classes="icon" 
                                    Content="Ã—" 
                                    FontSize="20"
                                    FontWeight="Light"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Command="{Binding SendMessageViewModel.HideLoadCommand}"/>
                        </Grid>
                    </Border>
                    
                    <!-- Content -->
                    <ScrollViewer Padding="16">
                        <StackPanel Spacing="8">
                            <!-- Empty state -->
                            <Border Classes="empty-state"
                                    IsVisible="{Binding !SendMessageViewModel.SavedMessages.Count}">
                                <StackPanel HorizontalAlignment="Center" Spacing="8">
                                    <TextBlock Text="ðŸ“­" FontSize="32" HorizontalAlignment="Center"/>
                                    <TextBlock Text="No saved templates yet" 
                                               Classes="body-strong" 
                                               HorizontalAlignment="Center"/>
                                    <TextBlock Text="Save a message to reuse it later" 
                                               Classes="caption" 
                                               HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Template list -->
                            <ItemsControl ItemsSource="{Binding SendMessageViewModel.SavedMessages}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:SavedMessage">
                                        <Border Classes="property-row" Padding="14,12" Margin="0,0,0,4">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <StackPanel Grid.Column="0" VerticalAlignment="Center" Spacing="4">
                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="14"/>
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <TextBlock Text="{Binding CreatedAt, StringFormat='{}{0:MMM d, yyyy}'}" 
                                                                   Classes="caption" FontSize="11"/>
                                                        <TextBlock Text="â€¢" Classes="caption" FontSize="11"/>
                                                        <TextBlock Text="{Binding ContentType}" 
                                                                   Classes="caption" FontSize="11"/>
                                                    </StackPanel>
                                                    <TextBlock Text="{Binding Body}" 
                                                               Classes="caption"
                                                               TextTrimming="CharacterEllipsis"
                                                               MaxLines="1"
                                                               FontSize="11"
                                                               Foreground="#8A8A8A"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1" 
                                                            Orientation="Horizontal" 
                                                            Spacing="8"
                                                            VerticalAlignment="Center">
                                                    <Button Classes="primary small" 
                                                            Content="Use Template"
                                                            Padding="14,6"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.LoadMessageCommand}"
                                                            CommandParameter="{Binding}"/>
                                                    <Button Classes="icon" 
                                                            Content="ðŸ—‘" 
                                                            FontSize="12"
                                                            ToolTip.Tip="Delete template"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.DeleteSavedMessageCommand}"
                                                            CommandParameter="{Binding}"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Connection Library Modal -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding ShowConnectionLibrary}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="600"
                    MaxWidth="800"
                    MaxHeight="600">
                <DockPanel>
                    <!-- Header -->
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,16">
                        <TextBlock Text="My Connections" Classes="heading"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                            <Button Classes="secondary small" 
                                    Content="Clear All"
                                    Command="{Binding ConnectionLibraryViewModel.ClearAllConnectionsCommand}"
                                    IsVisible="{Binding ConnectionLibraryViewModel.IsAddingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}"/>
                            <Button Classes="primary small" 
                                    Content="+ Add Connection"
                                    Command="{Binding ConnectionLibraryViewModel.StartAddConnectionCommand}"
                                    IsVisible="{Binding ConnectionLibraryViewModel.IsAddingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}"/>
                            <Button Classes="icon" 
                                    Content="Ã—" 
                                    FontSize="18"
                                    Command="{Binding CloseConnectionLibraryCommand}"/>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Add/Edit Connection Form (shown when adding or editing) -->
                    <Border DockPanel.Dock="Top" 
                            IsVisible="{Binding ConnectionLibraryViewModel.IsAddingConnection, FallbackValue=False}"
                            Classes="surface-subtle" 
                            Padding="16" 
                            Margin="0,0,0,16">
                        <StackPanel Spacing="12">
                            <Panel>
                                <TextBlock Text="Add New Connection" FontWeight="SemiBold" FontSize="14"
                                           IsVisible="{Binding ConnectionLibraryViewModel.IsEditingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}"/>
                                <TextBlock Text="Edit Connection" FontWeight="SemiBold" FontSize="14"
                                           IsVisible="{Binding ConnectionLibraryViewModel.IsEditingConnection, FallbackValue=False}"/>
                            </Panel>
                            
                            <StackPanel Spacing="4">
                                <TextBlock Text="Connection Name" Classes="caption"/>
                                <TextBox Text="{Binding ConnectionLibraryViewModel.NewConnectionName}" 
                                         Watermark="e.g., Production Service Bus"/>
                            </StackPanel>
                            
                            <StackPanel Spacing="4">
                                <TextBlock Text="Connection String" Classes="caption"/>
                                <TextBox Text="{Binding ConnectionLibraryViewModel.NewConnectionString}" 
                                         Watermark="Endpoint=sb://...;SharedAccessKeyName=...;SharedAccessKey=..."
                                         PasswordChar="â—"
                                         TextWrapping="Wrap"
                                         AcceptsReturn="False"
                                         MaxHeight="100"/>
                            </StackPanel>
                            
                            <!-- Detected info for namespace connections -->
                            <Border Classes="surface-success" Padding="8"
                                    IsVisible="{Binding ConnectionLibraryViewModel.DetectedInfo, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <TextBlock Text="{Binding ConnectionLibraryViewModel.DetectedInfo}" 
                                           Foreground="#0E7A0D"/>
                            </Border>
                            
                            <TextBlock Text="{Binding ConnectionLibraryViewModel.ValidationMessage}" 
                                       Foreground="#C42B1C"
                                       IsVisible="{Binding ConnectionLibraryViewModel.ValidationMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                       TextWrapping="Wrap"/>
                            
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                                <Button Classes="secondary small" 
                                        Content="Cancel" 
                                        Command="{Binding ConnectionLibraryViewModel.CancelAddConnectionCommand}"/>
                                <Button Classes="primary small" 
                                        Content="Save Connection" 
                                        Command="{Binding ConnectionLibraryViewModel.ValidateAndAddConnectionCommand}"
                                        IsEnabled="{Binding ConnectionLibraryViewModel.IsValidating, Converter={x:Static BoolConverters.Not}}"
                                        IsVisible="{Binding ConnectionLibraryViewModel.IsEditingConnection, Converter={x:Static BoolConverters.Not}, FallbackValue=True}"/>
                                <Button Classes="primary small" 
                                        Content="Update Connection" 
                                        Command="{Binding ConnectionLibraryViewModel.ValidateAndAddConnectionCommand}"
                                        IsEnabled="{Binding ConnectionLibraryViewModel.IsValidating, Converter={x:Static BoolConverters.Not}}"
                                        IsVisible="{Binding ConnectionLibraryViewModel.IsEditingConnection, FallbackValue=False}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    
                    <!-- Saved Connections List -->
                    <ScrollViewer>
                        <StackPanel Spacing="8">
                            <TextBlock Text="No saved connections yet" 
                                       Classes="caption" 
                                       HorizontalAlignment="Center"
                                       Margin="0,40"
                                       IsVisible="{Binding !ConnectionLibraryViewModel.SavedConnections.Count, FallbackValue=True}"/>
                            
                            <ItemsControl ItemsSource="{Binding ConnectionLibraryViewModel.SavedConnections}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:SavedConnection">
                                        <Border Classes="surface-subtle" 
                                                Padding="16" 
                                                Margin="0,0,0,4">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <Border Grid.Column="0" 
                                                        Classes="surface-brand"
                                                        Padding="10"
                                                        CornerRadius="4"
                                                        VerticalAlignment="Center"
                                                        Margin="0,0,12,0">
                                                    <TextBlock Text="â†—" FontSize="16" Foreground="#0F6CBD"/>
                                                </Border>
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="14"/>
                                                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                                        <Border Classes="badge-info" Padding="6,2">
                                                            <TextBlock Text="{Binding TypeDisplayName}" FontSize="11" Foreground="#0F6CBD"/>
                                                        </Border>
                                                        <TextBlock Text="{Binding EntityName}" Classes="caption" FontSize="12" VerticalAlignment="Center"
                                                                   IsVisible="{Binding EntityName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                                        <TextBlock Text="{Binding Endpoint}" Classes="caption" FontSize="12" VerticalAlignment="Center"
                                                                   IsVisible="{Binding IsNamespaceLevel}"/>
                                                    </StackPanel>
                                                    <TextBlock Text="{Binding CreatedAt, StringFormat='Added: {0:d}'}" 
                                                               Classes="caption" FontSize="11" Margin="0,4,0,0"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="2" 
                                                            Orientation="Horizontal" 
                                                            Spacing="8"
                                                            VerticalAlignment="Center">
                                                    <Button Classes="primary small" 
                                                            Content="Connect"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ConnectionLibraryViewModel.SelectConnectionCommand}"
                                                            CommandParameter="{Binding}"/>
                                                    <Button Classes="icon" 
                                                            Content="âœŽ"
                                                            FontSize="14"
                                                            ToolTip.Tip="Edit"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ConnectionLibraryViewModel.StartEditConnectionCommand}"
                                                            CommandParameter="{Binding}"/>
                                                    <Button Classes="icon" 
                                                            Content="Ã—"
                                                            FontSize="18"
                                                            ToolTip.Tip="Delete"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ConnectionLibraryViewModel.DeleteConnectionCommand}"
                                                            CommandParameter="{Binding}"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Settings Modal -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding ShowSettings}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="500"
                    MaxWidth="600">
                <DockPanel>
                    <!-- Header -->
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,20">
                        <TextBlock Text="Settings" Classes="heading"/>
                        <Button Classes="icon" 
                                Content="Ã—" 
                                FontSize="18"
                                HorizontalAlignment="Right"
                                Command="{Binding CloseSettingsCommand}"/>
                    </Grid>
                    
                    <ScrollViewer>
                        <StackPanel Spacing="24">
                            <!-- Confirmation Settings -->
                            <StackPanel Spacing="12">
                                <TextBlock Text="Confirmations" FontWeight="SemiBold" FontSize="14"/>
                                
                                <CheckBox IsChecked="{Binding SettingsViewModel.ConfirmBeforeDelete}"
                                          Content="Confirm before deleting messages"/>
                                
                                <CheckBox IsChecked="{Binding SettingsViewModel.ConfirmBeforePurge}"
                                          Content="Confirm before purging queues"/>
                            </StackPanel>
                            
                            <Separator/>
                            
                            <!-- Message Settings -->
                            <StackPanel Spacing="12">
                                <TextBlock Text="Messages" FontWeight="SemiBold" FontSize="14"/>
                                
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto">
                                    <TextBlock Text="Default message count to load" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="1" 
                                              ItemsSource="{Binding SettingsViewModel.AvailableMessageCounts}"
                                              SelectedItem="{Binding SettingsViewModel.DefaultMessageCount}"
                                              Width="100"/>
                                </Grid>
                                
                                <CheckBox IsChecked="{Binding SettingsViewModel.EnableMessagePreview}"
                                          Content="Enable message body preview in list"/>
                            </StackPanel>
                            
                            <Separator/>
                            
                            <!-- Auto Refresh Settings -->
                            <StackPanel Spacing="12">
                                <TextBlock Text="Auto Refresh" FontWeight="SemiBold" FontSize="14"/>
                                
                                <CheckBox IsChecked="{Binding SettingsViewModel.AutoRefreshMessages}"
                                          Content="Auto-refresh message list"/>
                                
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto"
                                      IsEnabled="{Binding SettingsViewModel.AutoRefreshMessages}">
                                    <TextBlock Text="Refresh interval (seconds)" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="1" 
                                              ItemsSource="{Binding SettingsViewModel.AvailableRefreshIntervals}"
                                              SelectedItem="{Binding SettingsViewModel.AutoRefreshIntervalSeconds}"
                                              Width="100"/>
                                </Grid>
                            </StackPanel>
                            
                            <Separator/>
                            
                            <!-- Display Settings -->
                            <StackPanel Spacing="12">
                                <TextBlock Text="Display" FontWeight="SemiBold" FontSize="14"/>
                                
                                <CheckBox IsChecked="{Binding SettingsViewModel.ShowDeadLetterBadges}"
                                          Content="Show dead letter count badges"/>
                                
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto">
                                    <TextBlock Text="Theme" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="1" 
                                              ItemsSource="{Binding SettingsViewModel.AvailableThemes}"
                                              SelectedItem="{Binding SettingsViewModel.Theme}"
                                              Width="120"/>
                                </Grid>
                            </StackPanel>
                            
                            <Separator/>
                            
                            <!-- Action Buttons -->
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
                                <Button Classes="secondary small" 
                                        Content="Reset to Defaults" 
                                        Command="{Binding SettingsViewModel.ResetToDefaultsCommand}"/>
                                <Button Classes="secondary small" 
                                        Content="Cancel" 
                                        Command="{Binding CloseSettingsCommand}"/>
                                <Button Classes="primary small" 
                                        Content="Save Settings" 
                                        Command="{Binding SettingsViewModel.SaveSettingsCommand}"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
    </Grid>
</Window>
