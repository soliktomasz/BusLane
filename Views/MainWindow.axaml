<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:BusLane.ViewModels"
        xmlns:models="using:BusLane.Models"
        x:Class="BusLane.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Service Bus Manager"
        Width="1280" Height="800"
        MinWidth="1000" MinHeight="600"
        WindowStartupLocation="CenterScreen">
    
    <Grid ColumnDefinitions="Auto,*">
        <!-- Sidebar -->
        <Border Grid.Column="0" Classes="sidebar">
            <DockPanel>
                <!-- Header -->
                <StackPanel DockPanel.Dock="Top" Margin="20,24,20,16">
                    <TextBlock Text="Service Bus" Classes="title"/>
                    <TextBlock Text="Manager" Classes="subtitle" Margin="0,2,0,0"/>
                </StackPanel>
                
                <!-- Auth Section -->
                <Border DockPanel.Dock="Top" Margin="12,0,12,16">
                    <StackPanel>
                        <Button Classes="primary" 
                                Content="Sign in with Azure"
                                Command="{Binding LoginCommand}"
                                IsVisible="{Binding !IsAuthenticated}"
                                HorizontalAlignment="Stretch"/>
                        
                        <Button Classes="secondary" 
                                Content="Sign Out"
                                Command="{Binding LogoutCommand}"
                                IsVisible="{Binding IsAuthenticated}"
                                HorizontalAlignment="Stretch"/>
                    </StackPanel>
                </Border>
                
                <!-- Subscription Picker -->
                <StackPanel DockPanel.Dock="Top" Margin="12,0,12,16"
                            IsVisible="{Binding IsAuthenticated}">
                    <TextBlock Text="Subscription" Classes="subtitle" Margin="4,0,0,6"/>
                    <ComboBox ItemsSource="{Binding Subscriptions}"
                              SelectedItem="{Binding SelectedAzureSubscription}"
                              HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="models:AzureSubscription">
                                <TextBlock Text="{Binding Name}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>
                
                <!-- Namespaces -->
                <TextBlock DockPanel.Dock="Top" Text="Namespaces" 
                           Classes="subtitle" Margin="16,0,0,8"
                           IsVisible="{Binding IsAuthenticated}"/>
                
                <ScrollViewer IsVisible="{Binding IsAuthenticated}">
                    <ListBox ItemsSource="{Binding Namespaces}"
                             Margin="8,0">
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="models:ServiceBusNamespace">
                                <StackPanel>
                                    <Button Classes="icon" 
                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectNamespaceCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Name}" FontWeight="Medium"/>
                                            <TextBlock Text="{Binding Location}" Classes="subtitle" FontSize="11"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </ScrollViewer>
            </DockPanel>
        </Border>
        
        <!-- Main Content -->
        <Grid Grid.Column="1" Margin="24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Welcome / Not Authenticated -->
            <StackPanel Grid.Row="1" 
                        VerticalAlignment="Center" 
                        HorizontalAlignment="Center"
                        IsVisible="{Binding !IsAuthenticated}">
                <TextBlock Text="Welcome" Classes="title" HorizontalAlignment="Center"/>
                <TextBlock Text="Sign in with your Azure account to get started" 
                           Classes="subtitle" HorizontalAlignment="Center" Margin="0,8"/>
            </StackPanel>
            
            <!-- Content when namespace selected -->
            <Grid Grid.Row="0" Grid.RowSpan="2" 
                  IsVisible="{Binding SelectedNamespace, Converter={x:Static ObjectConverters.IsNotNull}}"
                  RowDefinitions="Auto,*">
                
                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="{Binding SelectedNamespace.Name}" Classes="title"/>
                        <TextBlock Text="{Binding SelectedNamespace.ResourceGroup}" Classes="subtitle"/>
                    </StackPanel>
                    <Button Classes="secondary small" Content="â†» Refresh" 
                            Command="{Binding RefreshCommand}"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"/>
                </Grid>
                
                <!-- Main content grid -->
                <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*">
                    <!-- Service Bus Tree View -->
                    <Border Grid.Column="0" Classes="card" Margin="0,0,8,0">
                        <DockPanel>
                            <TextBlock DockPanel.Dock="Top" Text="Entities" Classes="heading" Margin="0,0,0,12"/>
                            <ScrollViewer>
                                <StackPanel>
                                    <!-- Queues Section -->
                                    <Expander IsExpanded="True" Margin="0,0,0,8">
                                        <Expander.Header>
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="ðŸ“¥" FontSize="14"/>
                                                <TextBlock Text="Queues" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                                                <Border Classes="badge-muted" Margin="4,0,0,0">
                                                    <TextBlock Text="{Binding Queues.Count}" FontSize="10" Foreground="#86868B"/>
                                                </Border>
                                            </StackPanel>
                                        </Expander.Header>
                                        <ListBox ItemsSource="{Binding Queues}"
                                                 SelectedItem="{Binding SelectedQueue}"
                                                 Margin="8,4,0,0">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate x:DataType="models:QueueInfo">
                                                    <Button Classes="icon"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectQueueCommand}"
                                                            CommandParameter="{Binding}"
                                                            HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Left">
                                                        <Grid ColumnDefinitions="*,Auto">
                                                            <StackPanel Grid.Column="0">
                                                                <TextBlock Text="{Binding Name}" FontWeight="Medium" FontSize="13"/>
                                                                <StackPanel Orientation="Horizontal" Margin="0,6,0,0" Spacing="6">
                                                                    <Border Classes="badge">
                                                                        <TextBlock Text="{Binding ActiveMessageCount}" 
                                                                                   Foreground="White" FontSize="10" FontWeight="Medium"/>
                                                                    </Border>
                                                                    <Border Classes="badge-danger" IsVisible="{Binding DeadLetterCount}">
                                                                        <TextBlock Text="{Binding DeadLetterCount, StringFormat='DLQ: {0}'}" 
                                                                                   Foreground="White" FontSize="10" FontWeight="Medium"/>
                                                                    </Border>
                                                                </StackPanel>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Button>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </Expander>
                                    
                                    <!-- Topics Section -->
                                    <Expander IsExpanded="True">
                                        <Expander.Header>
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="ðŸ“¤" FontSize="14"/>
                                                <TextBlock Text="Topics" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                                                <Border Classes="badge-muted" Margin="4,0,0,0">
                                                    <TextBlock Text="{Binding Topics.Count}" FontSize="10" Foreground="#86868B"/>
                                                </Border>
                                            </StackPanel>
                                        </Expander.Header>
                                        <ItemsControl ItemsSource="{Binding Topics}" Margin="8,4,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="models:TopicInfo">
                                                    <Expander Margin="0,2">
                                                        <Expander.Header>
                                                            <Button Classes="icon"
                                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectTopicCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    HorizontalAlignment="Stretch"
                                                                    HorizontalContentAlignment="Left"
                                                                    Padding="4">
                                                                <StackPanel>
                                                                    <TextBlock Text="{Binding Name}" FontWeight="Medium" FontSize="13"/>
                                                                    <TextBlock Text="{Binding SubscriptionCount, StringFormat='{}{0} subscription(s)'}" 
                                                                               Classes="subtitle" FontSize="11" Margin="0,4,0,0"/>
                                                                </StackPanel>
                                                            </Button>
                                                        </Expander.Header>
                                                        <!-- Topic Subscriptions (shown when topic expanded) -->
                                                        <ListBox ItemsSource="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).TopicSubscriptions}"
                                                                 SelectedItem="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectedSubscription}"
                                                                 Margin="16,4,0,0"
                                                                 IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectedTopic, Converter={x:Static ObjectConverters.IsNotNull}}">
                                                            <ListBox.ItemTemplate>
                                                                <DataTemplate x:DataType="models:SubscriptionInfo">
                                                                    <Button Classes="icon"
                                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectSubscriptionCommand}"
                                                                            CommandParameter="{Binding}"
                                                                            HorizontalAlignment="Stretch"
                                                                            HorizontalContentAlignment="Left">
                                                                        <StackPanel>
                                                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                                                <TextBlock Text="â†³" Foreground="#86868B" FontSize="12"/>
                                                                                <TextBlock Text="{Binding Name}" FontWeight="Medium" FontSize="12"/>
                                                                            </StackPanel>
                                                                            <StackPanel Orientation="Horizontal" Margin="14,4,0,0" Spacing="6">
                                                                                <Border Classes="badge">
                                                                                    <TextBlock Text="{Binding ActiveMessageCount}" 
                                                                                               Foreground="White" FontSize="10"/>
                                                                                </Border>
                                                                                <Border Classes="badge-danger" IsVisible="{Binding DeadLetterCount}">
                                                                                    <TextBlock Text="{Binding DeadLetterCount, StringFormat='DLQ: {0}'}" 
                                                                                               Foreground="White" FontSize="10"/>
                                                                                </Border>
                                                                            </StackPanel>
                                                                        </StackPanel>
                                                                    </Button>
                                                                </DataTemplate>
                                                            </ListBox.ItemTemplate>
                                                        </ListBox>
                                                    </Expander>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Expander>
                                </StackPanel>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>
                    
                    <!-- Messages Panel -->
                    <Border Grid.Column="1" Classes="card" Margin="8,0,0,0">
                        <DockPanel>
                            <!-- Messages Header -->
                            <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <TextBlock Text="Messages" Classes="heading" VerticalAlignment="Center"/>
                                    <ToggleButton Classes="pill" 
                                                  Content="Dead Letter"
                                                  IsChecked="{Binding ShowDeadLetter}"
                                                  Command="{Binding ToggleDeadLetterCommand}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                                    <Button Classes="secondary small" Content="Peek" 
                                            Command="{Binding LoadMessagesCommand}"/>
                                    <Button Classes="danger small" Content="Purge" 
                                            Command="{Binding PurgeMessagesCommand}"/>
                                </StackPanel>
                            </Grid>
                            
                            <!-- Send Message Button -->
                            <Border DockPanel.Dock="Top" 
                                    Margin="0,0,0,12"
                                    IsVisible="{Binding SelectedQueue, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <Button Classes="primary small" 
                                        Content="âœ‰ Send Message"
                                        Command="{Binding OpenSendMessagePopupCommand}"
                                        HorizontalAlignment="Left"/>
                            </Border>
                            
                            <!-- Send Message Button for Topic -->
                            <Border DockPanel.Dock="Top" 
                                    Margin="0,0,0,12"
                                    IsVisible="{Binding SelectedTopic, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <Button Classes="primary small" 
                                        Content="âœ‰ Send Message"
                                        Command="{Binding OpenSendMessagePopupCommand}"
                                        HorizontalAlignment="Left"/>
                            </Border>
                            
                            <!-- Messages List -->
                            <ScrollViewer>
                                <ListBox ItemsSource="{Binding Messages}"
                                         SelectedItem="{Binding SelectedMessage}">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:MessageInfo">
                                            <Button Classes="icon"
                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectMessageCommand}"
                                                    CommandParameter="{Binding}"
                                                    HorizontalAlignment="Stretch"
                                                    HorizontalContentAlignment="Left">
                                                <StackPanel Margin="0,4">
                                                    <Grid ColumnDefinitions="*,Auto">
                                                        <TextBlock Grid.Column="0" 
                                                                   Text="{Binding MessageId}" 
                                                                   FontWeight="Medium" 
                                                                   FontSize="12"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Grid.Column="1"
                                                                   Text="{Binding EnqueuedTime, StringFormat='{}{0:HH:mm:ss}'}" 
                                                                   Classes="subtitle" 
                                                                   FontSize="10"/>
                                                    </Grid>
                                                    <TextBlock Text="{Binding Body}" 
                                                               TextTrimming="CharacterEllipsis"
                                                               MaxLines="2"
                                                               Classes="subtitle" 
                                                               FontSize="11"
                                                               Margin="0,4,0,0"/>
                                                    <StackPanel Orientation="Horizontal" Margin="0,6,0,0" Spacing="6">
                                                        <Border Classes="badge-muted">
                                                            <TextBlock Text="{Binding SequenceNumber, StringFormat='Seq: {0}'}" 
                                                                       Foreground="#86868B" FontSize="10"/>
                                                        </Border>
                                                        <Border Classes="badge-muted" IsVisible="{Binding DeliveryCount}">
                                                            <TextBlock Text="{Binding DeliveryCount, StringFormat='Delivery: {0}'}" 
                                                                       Foreground="#86868B" FontSize="10"/>
                                                        </Border>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Button>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>
                </Grid>
            </Grid>
            
            <!-- Status Bar -->
            <Border Grid.Row="2" Margin="0,16,0,0">
                <Grid ColumnDefinitions="Auto,*">
                    <ProgressBar Grid.Column="0" 
                                 IsIndeterminate="True" 
                                 IsVisible="{Binding IsLoading}"
                                 Width="100" Height="4"/>
                    <Button Grid.Column="1" 
                            Classes="icon"
                            Command="{Binding ToggleStatusPopupCommand}"
                            HorizontalAlignment="Left"
                            Margin="12,0"
                            Cursor="Hand"
                            ToolTip.Tip="Click to see full message">
                        <TextBlock Text="{Binding StatusMessage}" 
                                   Classes="subtitle"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="400"/>
                    </Button>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Status Message Popup -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding ShowStatusPopup}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="400"
                    MaxWidth="600">
                <DockPanel>
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,16">
                        <TextBlock Text="Status Message" Classes="heading"/>
                        <Button Classes="icon" 
                                Content="âœ•" 
                                HorizontalAlignment="Right"
                                Command="{Binding CloseStatusPopupCommand}"/>
                    </Grid>
                    <Border Background="#F5F5F7" CornerRadius="8" Padding="12">
                        <SelectableTextBlock Text="{Binding StatusMessage}" 
                                             TextWrapping="Wrap" 
                                             FontFamily="Consolas, Monaco, monospace"
                                             FontSize="12"/>
                    </Border>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Message Detail Modal -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding SelectedMessage, Converter={x:Static ObjectConverters.IsNotNull}}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="500">
                <DockPanel>
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,16">
                        <TextBlock Text="Message Details" Classes="heading"/>
                        <Button Classes="icon" 
                                Content="âœ•" 
                                HorizontalAlignment="Right"
                                Command="{Binding ClearSelectedMessageCommand}"/>
                    </Grid>
                    <ScrollViewer>
                        <StackPanel Spacing="12">
                            <StackPanel>
                                <TextBlock Text="Message ID" Classes="subtitle" Margin="0,0,0,4"/>
                                <TextBlock Text="{Binding SelectedMessage.MessageId}" FontWeight="Medium" TextWrapping="Wrap"/>
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="Sequence Number" Classes="subtitle" Margin="0,0,0,4"/>
                                <TextBlock Text="{Binding SelectedMessage.SequenceNumber}"/>
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="Enqueued Time" Classes="subtitle" Margin="0,0,0,4"/>
                                <TextBlock Text="{Binding SelectedMessage.EnqueuedTime}"/>
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="Delivery Count" Classes="subtitle" Margin="0,0,0,4"/>
                                <TextBlock Text="{Binding SelectedMessage.DeliveryCount}"/>
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="Content Type" Classes="subtitle" Margin="0,0,0,4"/>
                                <TextBlock Text="{Binding SelectedMessage.ContentType}"/>
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="Body" Classes="subtitle" Margin="0,0,0,4"/>
                                <Border Background="#F5F5F7" CornerRadius="8" Padding="12">
                                    <TextBlock Text="{Binding SelectedMessage.Body}" 
                                               TextWrapping="Wrap" 
                                               FontFamily="Consolas, Monaco, monospace"
                                               FontSize="12"/>
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Send Message Popup -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding ShowSendMessagePopup}">
            <Border Background="White" 
                    CornerRadius="16"
                    Padding="24"
                    BoxShadow="0 8 32 0 #30000000"
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="700"
                    MaxWidth="900"
                    MaxHeight="700">
                <DockPanel>
                    <!-- Header -->
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,16">
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <TextBlock Text="Send Message" Classes="heading"/>
                            <TextBlock Text="to" Classes="subtitle" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding SendMessageViewModel.EntityName}" 
                                       FontWeight="SemiBold" 
                                       Foreground="#007AFF"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                            <Button Classes="secondary small" 
                                    Content="Load" 
                                    Command="{Binding SendMessageViewModel.ShowLoadCommand}"/>
                            <Button Classes="secondary small" 
                                    Content="Save" 
                                    Command="{Binding SendMessageViewModel.ShowSaveCommand}"/>
                            <Button Classes="secondary small" 
                                    Content="Clear" 
                                    Command="{Binding SendMessageViewModel.ClearFormCommand}"/>
                            <Button Classes="icon" 
                                    Content="âœ•" 
                                    Command="{Binding CancelSendMessageCommand}"/>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Error Message -->
                    <Border DockPanel.Dock="Top" 
                            Background="#FFEBE9" 
                            CornerRadius="8" 
                            Padding="12" 
                            Margin="0,0,0,12"
                            IsVisible="{Binding SendMessageViewModel.ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="{Binding SendMessageViewModel.ErrorMessage}" 
                                   Foreground="#CF222E"/>
                    </Border>
                    
                    <!-- Footer Buttons -->
                    <StackPanel DockPanel.Dock="Bottom" 
                                Orientation="Horizontal" 
                                HorizontalAlignment="Right" 
                                Spacing="8"
                                Margin="0,16,0,0">
                        <Button Classes="secondary" 
                                Content="Cancel" 
                                Command="{Binding CancelSendMessageCommand}"/>
                        <Button Classes="primary" 
                                Content="Send Message" 
                                Command="{Binding SendMessageViewModel.SendCommand}"
                                IsEnabled="{Binding !SendMessageViewModel.IsSending}"/>
                    </StackPanel>
                    
                    <!-- Content -->
                    <ScrollViewer>
                        <StackPanel Spacing="16">
                            <!-- Message Body -->
                            <StackPanel>
                                <TextBlock Text="Message Body *" FontWeight="Medium" Margin="0,0,0,8"/>
                                <TextBox Text="{Binding SendMessageViewModel.Body}"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"
                                         Height="120"
                                         Watermark="Enter your message body (JSON, XML, plain text, etc.)"/>
                            </StackPanel>
                            
                            <!-- Standard Properties -->
                            <Expander IsExpanded="True">
                                <Expander.Header>
                                    <TextBlock Text="Standard Properties" FontWeight="SemiBold"/>
                                </Expander.Header>
                                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" Margin="0,12,0,0">
                                    <Grid.Styles>
                                        <Style Selector="TextBlock.label">
                                            <Setter Property="FontSize" Value="12"/>
                                            <Setter Property="Foreground" Value="#86868B"/>
                                            <Setter Property="Margin" Value="0,0,0,4"/>
                                        </Style>
                                        <Style Selector="StackPanel.field">
                                            <Setter Property="Margin" Value="0,0,8,12"/>
                                        </Style>
                                    </Grid.Styles>
                                    
                                    <StackPanel Grid.Row="0" Grid.Column="0" Classes="field">
                                        <TextBlock Text="Content Type" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.ContentType}" 
                                                 Watermark="application/json"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="0" Grid.Column="1" Classes="field">
                                        <TextBlock Text="Message ID" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.MessageId}" 
                                                 Watermark="Auto-generated if empty"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="1" Grid.Column="0" Classes="field">
                                        <TextBlock Text="Correlation ID" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.CorrelationId}" 
                                                 Watermark="Optional"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="1" Grid.Column="1" Classes="field">
                                        <TextBlock Text="Session ID" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.SessionId}" 
                                                 Watermark="Required for session-enabled queues"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="2" Grid.Column="0" Classes="field">
                                        <TextBlock Text="Subject (Label)" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.Subject}" 
                                                 Watermark="Optional"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="2" Grid.Column="1" Classes="field">
                                        <TextBlock Text="To" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.To}" 
                                                 Watermark="Optional destination"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="3" Grid.Column="0" Classes="field">
                                        <TextBlock Text="Reply To" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.ReplyTo}" 
                                                 Watermark="Optional"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="3" Grid.Column="1" Classes="field">
                                        <TextBlock Text="Reply To Session ID" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.ReplyToSessionId}" 
                                                 Watermark="Optional"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="4" Grid.Column="0" Classes="field">
                                        <TextBlock Text="Partition Key" Classes="label"/>
                                        <TextBox Text="{Binding SendMessageViewModel.PartitionKey}" 
                                                 Watermark="Optional"/>
                                    </StackPanel>
                                </Grid>
                            </Expander>
                            
                            <!-- Scheduling -->
                            <Expander>
                                <Expander.Header>
                                    <TextBlock Text="Scheduling" FontWeight="SemiBold"/>
                                </Expander.Header>
                                <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                        <TextBlock Text="Time to Live" FontSize="12" Foreground="#86868B" Margin="0,0,0,4"/>
                                        <TextBox Text="{Binding SendMessageViewModel.TimeToLiveText}" 
                                                 Watermark="e.g., 00:30:00 or 1800 (seconds)"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                        <TextBlock Text="Scheduled Enqueue Time" FontSize="12" Foreground="#86868B" Margin="0,0,0,4"/>
                                        <TextBox Text="{Binding SendMessageViewModel.ScheduledEnqueueTimeText}" 
                                                 Watermark="e.g., 2024-12-25T10:00:00Z"/>
                                    </StackPanel>
                                </Grid>
                            </Expander>
                            
                            <!-- Custom Properties -->
                            <Expander>
                                <Expander.Header>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="Custom Properties" FontWeight="SemiBold"/>
                                        <Border Classes="badge-muted">
                                            <TextBlock Text="{Binding SendMessageViewModel.CustomProperties.Count}" 
                                                       FontSize="10" Foreground="#86868B"/>
                                        </Border>
                                    </StackPanel>
                                </Expander.Header>
                                <StackPanel Margin="0,12,0,0" Spacing="8">
                                    <ItemsControl ItemsSource="{Binding SendMessageViewModel.CustomProperties}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="models:CustomProperty">
                                                <Grid ColumnDefinitions="*,*,Auto" Margin="0,0,0,4">
                                                    <TextBox Grid.Column="0" 
                                                             Text="{Binding Key}" 
                                                             Watermark="Key"
                                                             Margin="0,0,8,0"/>
                                                    <TextBox Grid.Column="1" 
                                                             Text="{Binding Value}" 
                                                             Watermark="Value"
                                                             Margin="0,0,8,0"/>
                                                    <Button Grid.Column="2" 
                                                            Classes="icon" 
                                                            Content="âœ•"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.RemoveCustomPropertyCommand}"
                                                            CommandParameter="{Binding}"/>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    <Button Classes="secondary small" 
                                            Content="+ Add Property" 
                                            Command="{Binding SendMessageViewModel.AddCustomPropertyCommand}"
                                            HorizontalAlignment="Left"/>
                                </StackPanel>
                            </Expander>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
        
        <!-- Save Message Dialog -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding SendMessageViewModel.ShowSaveDialog, FallbackValue=False, TargetNullValue=False}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="400">
                <StackPanel Spacing="16">
                    <TextBlock Text="Save Message Template" Classes="heading"/>
                    <StackPanel>
                        <TextBlock Text="Template Name" FontSize="12" Foreground="#86868B" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding SendMessageViewModel.SaveMessageName}" 
                                 Watermark="Enter a name for this message template"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                        <Button Classes="secondary" 
                                Content="Cancel" 
                                Command="{Binding SendMessageViewModel.HideSaveCommand}"/>
                        <Button Classes="primary" 
                                Content="Save" 
                                Command="{Binding SendMessageViewModel.SaveMessageCommand}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
        
        <!-- Load Message Dialog -->
        <Border Grid.Column="0" 
                Grid.ColumnSpan="2" 
                Classes="modal-overlay"
                IsVisible="{Binding SendMessageViewModel.ShowLoadDialog, FallbackValue=False, TargetNullValue=False}">
            <Border Classes="modal" 
                    VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    MinWidth="500"
                    MaxHeight="500">
                <DockPanel>
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,16">
                        <TextBlock Text="Load Saved Message" Classes="heading"/>
                        <Button Classes="icon" 
                                Content="âœ•" 
                                HorizontalAlignment="Right"
                                Command="{Binding SendMessageViewModel.HideLoadCommand}"/>
                    </Grid>
                    <ScrollViewer>
                        <StackPanel Spacing="4">
                            <TextBlock Text="No saved messages" 
                                       Classes="subtitle" 
                                       HorizontalAlignment="Center"
                                       Margin="0,20"
                                       IsVisible="{Binding SendMessageViewModel.SavedMessages.Count, Converter={x:Static ObjectConverters.IsNull}, FallbackValue=True}"/>
                            <ItemsControl ItemsSource="{Binding SendMessageViewModel.SavedMessages}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:SavedMessage">
                                        <Border Background="#F5F5F7" 
                                                CornerRadius="8" 
                                                Padding="12" 
                                                Margin="0,0,0,8">
                                            <Grid ColumnDefinitions="*,Auto,Auto">
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="{Binding Name}" FontWeight="Medium"/>
                                                    <TextBlock Text="{Binding CreatedAt, StringFormat='Created: {0:g}'}" 
                                                               Classes="subtitle" 
                                                               FontSize="11" 
                                                               Margin="0,4,0,0"/>
                                                    <TextBlock Text="{Binding Body}" 
                                                               Classes="subtitle"
                                                               TextTrimming="CharacterEllipsis"
                                                               MaxLines="1"
                                                               FontSize="11"
                                                               Margin="0,2,0,0"/>
                                                </StackPanel>
                                                <Button Grid.Column="1" 
                                                        Classes="primary small" 
                                                        Content="Load"
                                                        Margin="8,0"
                                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.LoadMessageCommand}"
                                                        CommandParameter="{Binding}"/>
                                                <Button Grid.Column="2" 
                                                        Classes="icon" 
                                                        Content="ðŸ—‘"
                                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SendMessageViewModel.DeleteSavedMessageCommand}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Border>
    </Grid>
</Window>
